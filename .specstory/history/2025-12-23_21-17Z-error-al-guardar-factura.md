<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 0d04ec35-21e4-4fed-93f8-35a3a19a3331 (2025-12-23 21:17Z) -->

# Error al guardar factura (2025-12-23 21:17Z)

_**User (2025-12-23 15:16Z)**_

@spisa/SPISA.Presentacion cuando almaceno la factura, me da error. Este es el log que veo. 20251223|18:18:17|Categorias_TraerPorId|IdCategoria=2&|Returned Value: IdCategoria=2
20251223|18:18:17|Articulos_TraerTodos|Codigo=BSS1502&|Returned Value: IdArticulo=105
20251223|18:18:17|Categorias_TraerPorId|IdCategoria=1&|Returned Value: IdCategoria=1
20251223|18:18:17|Articulos_TraerTodos|Codigo=CRL902&|Returned Value: IdArticulo=297
20251223|18:18:17|Categorias_TraerPorId|IdCategoria=1&|Returned Value: IdCategoria=1
20251223|18:18:17|Articulos_TraerTodos|Codigo=CRL903&|Returned Value: IdArticulo=301
20251223|18:18:17|Categorias_TraerPorId|IdCategoria=1&|Returned Value: IdCategoria=1
20251223|18:18:17|Categorias_TraerPorId|IdCategoria=2&|Returned Value: IdCategoria=2
20251223|18:18:17|Categorias_TraerPorId|IdCategoria=4&|Returned Value: IdCategoria=4
20251223|18:18:17|Categorias_TraerPorId|IdCategoria=6&|Returned Value: IdCategoria=6
20251223|18:18:17|Categorias_TraerPorId|IdCategoria=9&|Returned Value: IdCategoria=9
20251223|18:18:17|Categorias_TraerPorId|IdCategoria=13&|Returned Value: IdCategoria=13
20251223|18:18:17|Clientes_TraerClientePorCodigo|Codigo=14&|Returned Value: IdCliente=26
20251223|18:18:17|Categorias_TraerPorId|IdCategoria=2&|Returned Value: IdCategoria=2
20251223|18:18:17|Articulos_TraerTodos|Codigo=BSS1502&|Returned Value: IdArticulo=105
20251223|18:18:17|Categorias_TraerPorId|IdCategoria=1&|Returned Value: IdCategoria=1
20251223|18:18:17|Articulos_TraerTodos|Codigo=CRL902&|Returned Value: IdArticulo=297
20251223|18:18:17|Categorias_TraerPorId|IdCategoria=1&|Returned Value: IdCategoria=1
20251223|18:18:17|Articulos_TraerTodos|Codigo=CRL903&|Returned Value: IdArticulo=301
20251223|18:18:17|NotaPedido_Items_BorrarPorIdNotaPedido|IdNotaPedido=132450&|Returned Value: 3 rows afectadas
20251223|18:18:17|NotaPedido_Items_AgregarItem|IdNotaPedido=132450&IdArticulo=105&Cantidad=23&PrecioUnitario=19.80&Descuento=30&|Returned Value: 1 rows afectadas
20251223|18:18:17|NotaPedido_Items_AgregarItem|IdNotaPedido=132450&IdArticulo=297&Cantidad=50&PrecioUnitario=7.04&Descuento=20&|Returned Value: 1 rows afectadas
20251223|18:18:17|NotaPedido_Items_AgregarItem|IdNotaPedido=132450&IdArticulo=301&Cantidad=23&PrecioUnitario=16.28&Descuento=20&|Returned Value: 1 rows afectadas
 . Dame un exec de store procedure que pueda probar para ver por que falla en la base local.

---

_**Agent (model claude-4.5-sonnet-thinking, mode Agent)**_

<think><details><summary>Thought Process</summary>
The user is showing me a screenshot of an invoice/order form in what appears to be a Windows desktop application (SPISA.Presentacion). They're getting an error when trying to save the invoice.

Looking at the log they provided:
1. It's fetching categories and articles (Categorias_TraerPorId, Articulos_TraerTodos)
2. It's fetching a client (Clientes_TraerClientePorCodigo with Codigo=14, returning IdCliente=26)
3. It's deleting existing items (NotaPedido_Items_BorrarPorIdNotaPedido for IdNotaPedido=132450, affecting 3 rows)
4. It's adding new items (NotaPedido_Items_AgregarItem for 3 different articles)

The log shows successful operations up to this point. The user says there's an error when storing the invoice, but the log ends after adding the items. This suggests the error might be happening in a subsequent stored procedure call that's not shown in the log.

Looking at the screenshot:
- Order number: 1
- Invoice number: 0000-00031589
- Date: 12/23/2025
- Client: AMIANGRAF S.R.L.
- 3 items in the order
- Various totals calculated at the bottom

The user is asking me to provide an EXEC statement for a stored procedure that they can test locally to see why it's failing.

Based on the log, I need to:
1. Look at the presentation layer code to understand the full flow
2. Identify what stored procedure is being called after the items are added
3. Provide them with a test EXEC statement

Let me read the relevant files from the SPISA.Presentacion folder to understand the invoice saving logic.</details></think>

---

Necesito examinar el código de la capa de presentación para entender el flujo completo al guardar la factura y ver qué stored procedure está fallando después de agregar los items.

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">

</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">

</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "NotaPedido.*Guardar|NotaPedido.*Almacenar|Factura.*Guardar|Factura.*Almacenar" in "d:/dialfa new/spisa/SPISA.Presentacion" • 16 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `SPISA.Presentacion\bin\Debug\Logs\Log.txt` | `20251218\|22:36:57\|NotaPedido_Guardar\|IdCliente=26&FechaEmision=12/18/2025 10:36:36 PM&FechaEntrega=12/18/2025 10:36:36 PM&DescuentoEspecial=0&Observaciones=&\|Returned Value: IdNotaPedido=132458` | L61 |
| `SPISA.Presentacion\frmPrincipal.cs` | `NotaPedido np = ucNP.Guardar();` | L666 |
| `SPISA.Presentacion\frmPrincipal.cs` | `Factura f = ucFactura.Guardar();` | L783 |
| `SPISA.Presentacion\ExplorerBarGroups.xml` | `<item tag="itemAlmacenarFactura">Almacenar Factura</item>` | L56 |
| `SPISA.Presentacion\ExplorerBarGroups.xml` | `<item tag="itemAlmacenarFactura">Almacenar Factura</item>` | L59 |
| `SPISA.Presentacion\ExplorerBarGroups.xml` | `<item tag="itemAlmacenarFactura">Almacenar Factura</item>` | L65 |
| `SPISA.Presentacion\bin\Debug\ExplorerBarGroups.xml` | `<item tag="itemAlmacenarFactura">Almacenar Factura</item>` | L56 |
| `SPISA.Presentacion\bin\Debug\ExplorerBarGroups.xml` | `<item tag="itemAlmacenarFactura">Almacenar Factura</item>` | L59 |
| `SPISA.Presentacion\bin\Debug\ExplorerBarGroups.xml` | `<item tag="itemAlmacenarFactura">Almacenar Factura</item>` | L65 |
| `SPISA.Presentacion\UC\NotaPedido.cs` | `public NotaPedido Guardar()` | L288 |
| `SPISA.Presentacion\UC\NotaPedido.cs` | `int IdNotaPedido = np.Guardar();` | L361 |
| `SPISA.Presentacion\UC\Factura.cs` | `_factura.AlmacenarImpresion(_factura.EsNotaDeCredito);` | L706 |
| `SPISA.Presentacion\UC\Factura.cs` | `/// Si la factura proviene de una nota de pedido, la factura podra guardarse una sola vez. Para volver a generarla, habra una opcion` | L736 |
| `SPISA.Presentacion\UC\Factura.cs` | `public Factura Guardar()` | L742 |
| `SPISA.Presentacion\UC\Factura.cs` | `int idFactura = f.Guardar();` | L801 |
| `SPISA.Presentacion\Notes\Cambios a Realizar.txt` | `- Cambiar tipo de dato del SP de Facturas_GuardarFactura del campo NumeroFactura de int a bigint` | L9 |


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: d:/dialfa new/spisa/SPISA.Presentacion/UC/Factura.cs</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "Facturas_Guardar|Factura.*Guardar.*SP|SP.*Factura.*Guardar" in "d:/dialfa new/spisa" • 25 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `.\SPISA_Database\fix_factura_guardar_sp.sql` | `-- FIX: Actualizar Stored Procedure Facturas_GuardarFactura` | L2 |
| `.\SPISA_Database\fix_factura_guardar_sp.sql` | `IF EXISTS (SELECT * FROM sys.objects WHERE type = 'P' AND name = 'Facturas_GuardarFactura')` | L12 |
| `.\SPISA_Database\fix_factura_guardar_sp.sql` | `DROP PROCEDURE [dbo].[Facturas_GuardarFactura]` | L14 |
| `.\SPISA_Database\fix_factura_guardar_sp.sql` | `CREATE PROCEDURE [dbo].[Facturas_GuardarFactura]` | L19 |
| `.\SPISA_Database\fix_factura_guardar_sp.sql` | `PRINT 'Stored Procedure Facturas_GuardarFactura actualizado correctamente'` | L44 |
| `.\SPISA_Database\Create Scripts\StoredProcedures.sql` | `/****** Object:  StoredProcedure [dbo].[Facturas_GuardarFactura]    Script Date: 09/08/2007 20:32:47 ******/` | L860 |
| `.\SPISA_Database\Create Scripts\StoredProcedures.sql` | `CREATE PROCEDURE [dbo].[Facturas_GuardarFactura]` | L865 |
| `.\SPISA_LogicaDeNegocios\_SpisaEntityModel.edmx` | `<Function Name="Facturas_GuardarFactura" Aggregate="false" BuiltIn="false" NiladicFunction="false" IsComposable="false" ParameterTypeSemantics="AllowImplicitConversion" Schema="dbo">` | L1372 |
| `.\SPISA_LogicaDeNegocios\consts.cs` | `public const string Facturas_GuardarFactura = "Facturas_GuardarFactura";` | L22 |
| `.\SPISA_LogicaDeNegocios\Factura.cs` | `/// Facturas_GuardarFactura realiza las siguientes operaciones` | L484 |
| `.\SPISA_LogicaDeNegocios\Factura.cs` | `string sqlCommand = Consts.Facturas_GuardarFactura;` | L508 |
| `.\SPISA_LogicaDeNegocios\Factura.cs` | `Logger.Append(Consts.Facturas_GuardarFactura, new Object[]\{   "FechaEmision", this._FechaEmision.ToString(),` | L542 |
| `.\Backup\SPISA_LogicaDeNegocios\Factura.cs` | `/// Facturas_GuardarFactura realiza las siguientes operaciones` | L484 |
| `.\Backup\SPISA_LogicaDeNegocios\Factura.cs` | `string sqlCommand = Consts.Facturas_GuardarFactura;` | L508 |
| `.\Backup\SPISA_LogicaDeNegocios\Factura.cs` | `Logger.Append(Consts.Facturas_GuardarFactura, new Object[]\{   "FechaEmision", this._FechaEmision.ToString(),` | L542 |
| `.\Backup\SPISA_LogicaDeNegocios\consts.cs` | `public const string Facturas_GuardarFactura = "Facturas_GuardarFactura";` | L22 |
| `.\SPISA.Presentacion\Notes\Cambios a Realizar.txt` | `- Cambiar tipo de dato del SP de Facturas_GuardarFactura del campo NumeroFactura de int a bigint` | L9 |
| `.\Backup\SPISA.Presentacion\Notes\Cambios a Realizar.txt` | `- Cambiar tipo de dato del SP de Facturas_GuardarFactura del campo NumeroFactura de int a bigint` | L9 |
| `.\v2.0\SPISA_LogicaDeNegocios\consts.cs` | `public const string Facturas_GuardarFactura = "Facturas_GuardarFactura";` | L22 |
| `.\v2.0\SPISA_LogicaDeNegocios\Factura.cs` | `/// Facturas_GuardarFactura realiza las siguientes operaciones` | L484 |
| `.\v2.0\SPISA_LogicaDeNegocios\Factura.cs` | `string sqlCommand = Consts.Facturas_GuardarFactura;` | L508 |
| `.\v2.0\SPISA_LogicaDeNegocios\Factura.cs` | `Logger.Append(Consts.Facturas_GuardarFactura, new Object[]\{   "FechaEmision", this._FechaEmision.ToString(),` | L542 |
| `.\v2.0\SPISA.Presentacion\Notes\Cambios a Realizar.txt` | `- Cambiar tipo de dato del SP de Facturas_GuardarFactura del campo NumeroFactura de int a bigint` | L9 |
| `.\v2.0\SPISA_Database\Create Scripts\StoredProcedures.sql` | `/****** Object:  StoredProcedure [dbo].[Facturas_GuardarFactura]    Script Date: 09/08/2007 20:32:47 ******/` | L860 |
| `.\v2.0\SPISA_Database\Create Scripts\StoredProcedures.sql` | `CREATE PROCEDURE [dbo].[Facturas_GuardarFactura]` | L865 |


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: d:/dialfa new/spisa/SPISA_LogicaDeNegocios/Factura.cs</summary>

</details>
</tool-use>

---

Ahora veo el flujo completo. El problema ocurre cuando se llama al stored procedure `Facturas_GuardarFactura`. Déjame ver el SP completo:

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "CREATE PROCEDURE.*Facturas_GuardarFactura" in "d:/dialfa new/spisa/SPISA_Database" • 2 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `SPISA_Database\fix_factura_guardar_sp.sql` | `CREATE PROCEDURE [dbo].[Facturas_GuardarFactura]` | L19 |
| `SPISA_Database\Create Scripts\StoredProcedures.sql` | `CREATE PROCEDURE [dbo].[Facturas_GuardarFactura]` | L865 |


</details>
</tool-use>

---

Perfecto. Ahora tengo toda la información necesaria. Basándome en el log que proporcionaste, veo que:

1. Se recuperan artículos y categorías
2. Se recupera el cliente (IdCliente=26)
3. Se borran los items anteriores del pedido 132450
4. Se agregan 3 nuevos items correctamente
5. **Después debería llamarse al SP `Facturas_GuardarFactura`** pero ahí es donde falla

El error probablemente ocurre porque hay algún problema con:
- El `IdNotaPedido` (132450)
- El `NumeroFactura` que estás tratando de insertar (0000-00031598)
- O alguna constraint de la tabla `Facturas`

Aquí te proporciono el EXEC que puedes probar para diagnosticar el problema:

```sql
-- EXEC para probar el stored procedure Facturas_GuardarFactura
-- Basado en los datos del log que proporcionaste

DECLARE @IdFacturaGenerado INT

EXEC [dbo].[Facturas_GuardarFactura]
    @Fecha = '2025-12-23 18:18:17',
    @IdNotaPedido = 132450,
    @IdCliente = 26,
    @NumeroFactura = 31598,  -- Sin guiones ni ceros a la izquierda
    @Observaciones = '',
    @DescuentoEspecial = 0,
    @ValorDolar = 1250.00,
    @EsNotaDeCredito = 0

-- Ver qué retorna
SELECT @IdFacturaGenerado = @@IDENTITY
SELECT @IdFacturaGenerado AS 'IdFacturaGenerado'

-- Verificar que se insertó correctamente
SELECT TOP 1 * FROM Facturas ORDER BY IdFactura DESC
```

**Posibles causas del error:**

1. **Violación de clave única**: El `NumeroFactura` 31598 ya existe en la tabla
2. **Violación de FK**: El `IdNotaPedido` 132450 no existe o ya tiene una factura asociada
3. **Violación de FK**: El `IdCliente` 26 no existe
4. **Check constraint**: Algún campo tiene un valor inválido

**Para diagnosticar, ejecuta estos queries adicionales:**

```sql
-- 1. Verificar si el NumeroFactura ya existe
SELECT * FROM Facturas WHERE NumeroFactura = 31598

-- 2. Verificar si el IdNotaPedido existe y si ya tiene factura
SELECT np.IdNotaPedido, np.IdCliente, np.DescuentoEspecial, 
       f.IdFactura, f.NumeroFactura
FROM NotaPedidos np
LEFT JOIN Facturas f ON f.IdNotaPedido = np.IdNotaPedido
WHERE np.IdNotaPedido = 132450

-- 3. Verificar si el cliente existe
SELECT * FROM Clientes WHERE IdCliente = 26

-- 4. Ver los items del pedido que acabas de agregar
SELECT * FROM NotaPedido_Items 
WHERE IdNotaPedido = 132450

-- 5. Ver constraints de la tabla Facturas
SELECT 
    OBJECT_NAME(object_id) AS ConstraintName,
    type_desc,
    definition
FROM sys.check_constraints
WHERE parent_object_id = OBJECT_ID('Facturas')

SELECT 
    fk.name AS ForeignKeyName,
    OBJECT_NAME(fk.parent_object_id) AS TableName,
    COL_NAME(fkc.parent_object_id, fkc.parent_column_id) AS ColumnName,
    OBJECT_NAME(fk.referenced_object_id) AS ReferencedTableName,
    COL_NAME(fkc.referenced_object_id, fkc.referenced_column_id) AS ReferencedColumnName
FROM sys.foreign_keys AS fk
INNER JOIN sys.foreign_key_columns AS fkc 
    ON fk.object_id = fkc.constraint_object_id
WHERE fk.parent_object_id = OBJECT_ID('Facturas')
```

**Mi hipótesis principal es que el `NumeroFactura` 31598 ya existe en la tabla `Facturas`**, ya que no veo ninguna constraint UNIQUE en el SP pero probablemente existe en la tabla.

Ejecuta estos queries y dime qué resultados obtienes para identificar exactamente cuál es el problema.

---

_**User (2025-12-23 15:16Z)**_

esto es lo que veo

---

_**Agent (model claude-4.5-sonnet-thinking, mode Agent)**_

<think><details><summary>Thought Process</summary>
Perfecto, el usuario me está mostrando los resultados de las queries que sugerí. Déjame analizar lo que veo:

1. **Primera tabla - Facturas**: Muestra las columnas de la tabla Facturas con sus Foreign Keys
   - Veo que `IdNotaPedido` y `NumeroFactura` son NULL en la consulta de NotaPedidos

2. **Segunda tabla - NotaPedidos JOIN con Facturas**:
   - IdNotaPedido: 132450
   - IdCliente: 26
   - DescuentoEspecial: 0
   - IdFactura: NULL
   - NumeroFactura: NULL
   - **Esto significa que el pedido 132450 NO tiene factura asociada todavía**, lo cual es correcto.

3. **Tercera tabla - Cliente**:
   - IdCliente: 26
   - Código: 14
   - RazonSocial: AMIANGRAF S.R.L.
   - **El cliente existe**, así que no es problema de FK con clientes.

4. **Cuarta tabla - Items del pedido**:
   - Se ven 3 items con IdNotaPedido 132450
   - IdArticulo: 105, 297, 301
   - Cantidades: 23, 50, 23
   - Precios y descuentos correctos
   - **Los items se guardaron correctamente**
   - **PROBLEMA DETECTADO**: El campo `Descuento` tiene valor `-1.00` en los 3 items. Esto parece extraño. Debería ser 30, 20, 20 según el log.

5. **Quinta tabla - Constraints**: No hay check constraints en la tabla Facturas

6. **Sexta tabla - Foreign Keys**:
   - FK_Facturas1_1NotaPedidos: Facturas.IdNotaPedido -> NotaPedidos.IdNotaPedido
   - **Esta es la única FK en la tabla Facturas**

Detecto un problema crítico con los descuentos de los items. Los valores `-1.00` son inusuales y podrían bloquear la generación de la factura. Necesito investigar por qué los descuentos no coinciden con los valores esperados.

Solicito al usuario ejecutar el procedimiento almacenado para identificar el error específico que impide la inserción.</details></think>

---

Excelente, ahora veo información muy útil. Déjame analizar los resultados:

✅ **Lo que está BIEN:**
1. El NotaPedido 132450 existe y NO tiene factura asignada todavía (IdFactura=NULL, NumeroFactura=NULL)
2. El Cliente 26 (AMIANGRAF S.R.L.) existe
3. Los 3 items del pedido se guardaron correctamente
4. Solo hay 1 Foreign Key en Facturas: `FK_Facturas1_1NotaPedidos` (Facturas.IdNotaPedido -> NotaPedidos.IdNotaPedido)

⚠️ **PROBLEMA DETECTADO:**
Los descuentos en `NotaPedido_Items` son **-1.00** en lugar de los valores esperados:
- Según el log: `Descuento=30`, `Descuento=20`, `Descuento=20`
- En la BD: `Descuento=-1.00` en los 3 items

Esto indica que el SP `NotaPedido_Items_AgregarItem` está guardando -1 en lugar de los descuentos reales.

**Ahora ejecuta este EXEC para ver el error exacto:**

```sql
BEGIN TRY
    DECLARE @IdFactura INT
    
    EXEC @IdFactura = [dbo].[Facturas_GuardarFactura]
        @Fecha = '2025-12-23 18:18:17',
        @IdNotaPedido = 132450,
        @IdCliente = 26,
        @NumeroFactura = 31598,
        @Observaciones = '',
        @DescuentoEspecial = 0,
        @ValorDolar = 1250.00,
        @EsNotaDeCredito = 0
    
    SELECT @IdFactura AS 'IdFacturaGenerado'
    
    -- Ver si se insertó
    SELECT * FROM Facturas WHERE IdNotaPedido = 132450
    
END TRY
BEGIN CATCH
    SELECT 
        ERROR_NUMBER() AS ErrorNumber,
        ERROR_SEVERITY() AS ErrorSeverity,
        ERROR_STATE() AS ErrorState,
        ERROR_PROCEDURE() AS ErrorProcedure,
        ERROR_LINE() AS ErrorLine,
        ERROR_MESSAGE() AS ErrorMessage
END CATCH
```

Este query te va a mostrar exactamente qué error está ocurriendo al intentar insertar la factura.

---

_**User (2025-12-23 15:16Z)**_



---

_**Agent (model claude-4.5-sonnet-thinking, mode Agent)**_

<think><details><summary>Thought Process</summary>
¡Perfecto! Ahora tengo el error exacto:

- **ErrorNumber**: 201
- **ErrorSeverity**: 16
- **ErrorState**: 4
- **ErrorProcedure**: dbo.Facturas_GuardarFactura
- **ErrorLine**: 0
- **ErrorMessage**: "Procedure or function 'Facturas_GuardarFactura' ..."

El error 201 en SQL Server significa: "Procedure or function expects parameter which was not supplied" o hay un problema con los parámetros del stored procedure.

Esto sugiere que el stored procedure en la base de datos puede tener una definición diferente a la que el código C# está esperando. Necesito ver la definición actual del SP en la base de datos.</details></think>

---

Excelente, ahí está el problema:

**Error 201**: "Procedure or function 'Facturas_GuardarFactura' expects parameter which was not supplied"

Esto significa que el stored procedure en tu base de datos tiene una firma diferente a la que el código C# está intentando llamar.

**Ejecuta este query para ver la definición actual del SP en tu base de datos:**

```sql
-- Ver la definición exacta del SP tal como está en tu BD
SELECT OBJECT_DEFINITION(OBJECT_ID('dbo.Facturas_GuardarFactura'))

-- O también:
EXEC sp_helptext 'Facturas_GuardarFactura'
```

**También verifica los parámetros esperados:**

```sql
SELECT 
    p.name AS ParameterName,
    TYPE_NAME(p.user_type_id) AS DataType,
    p.max_length,
    p.is_output
FROM sys.parameters p
WHERE p.object_id = OBJECT_ID('dbo.Facturas_GuardarFactura')
ORDER BY p.parameter_id
```

**Mi hipótesis es que:**
El SP en tu base de datos local probablemente tiene parámetros adicionales o diferentes nombres que el código C# no está enviando. Posiblemente:
- Faltan parámetros adicionales que se agregaron después
- Los nombres de los parámetros son diferentes
- O el SP no fue actualizado correctamente después de alguna migración

Ejecuta estos dos queries y muéstrame los resultados para confirmar cuál es la diferencia exacta entre lo que el código envía y lo que el SP espera.

---

_**User (2025-12-23 15:16Z)**_



---

_**Agent (model claude-4.5-sonnet-thinking, mode Agent)**_

<think><details><summary>Thought Process</summary>
Perfecto, ahora veo el problema claramente. El stored procedure en la base de datos tiene 9 parámetros:

1. @Fecha - datetime
2. @IdNotaPedido - int
3. @IdCliente - int
4. @NumeroFactura - bigint
5. @Observaciones - varchar
6. @DescuentoEspecial - int
7. @ValorDolar - float
8. @EsNotaDeCredito - bit
9. @EsCotizacion - bit  ⚠️ **ESTE ES EL PARÁMETRO FALTANTE**

Pero si voy al código C# que revisamos antes (líneas 530-537 de Factura.cs), solo se están enviando 8 parámetros:

```csharp
db.AddInParameter(dbCommand, "Fecha", DbType.DateTime, this._FechaEmision);
db.AddInParameter(dbCommand, "IdNotaPedido", DbType.Int32, this._NotaPedido.IdNotaPedido);
db.AddInParameter(dbCommand, "IdCliente", DbType.Int32, (this._Cliente != null ? this._Cliente.Id : -1));
db.AddInParameter(dbCommand, "NumeroFactura", DbType.Int64, this._NumeroFactura);
db.AddInParameter(dbCommand, "Observaciones", DbType.String, (this._Observaciones != null ? this._Observaciones : ""));
db.AddInParameter(dbCommand, "DescuentoEspecial", DbType.Int32, this._DescuentoEspecial);
db.AddInParameter(dbCommand, "ValorDolar", DbType.Decimal, (this._valorDolar != 0 ? this._valorDolar : 0));
db.AddInParameter(dbCommand, "EsNotaDeCredito", DbType.Boolean, this._esNotaDeCredito);


```

El problema es evidente: falta el parámetro @EsCotizacion en la llamada. Necesito evaluar las opciones para resolver esta discrepancia entre el stored procedure y el código C#.

Requiero investigar los detalles específicos para determinar la solución más adecuada, considerando el contexto completo de la implementación.</details></think>

---

**¡AHÍ ESTÁ EL PROBLEMA!**

El stored procedure en tu base de datos tiene **9 parámetros** pero el código C# solo está enviando **8 parámetros**.

**Falta el parámetro:** `@EsCotizacion` (bit)

Ahora necesito ver el código C# para confirmar esto. Déjame verificar:

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: d:/dialfa new/spisa/SPISA_LogicaDeNegocios/Factura.cs</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "EsCotizacion|esCotizacion|_esCotizacion" in "d:/dialfa new/spisa/SPISA_LogicaDeNegocios/Factura.cs" • 0 matches</summary>

Output mode: content


_No matches found_

</details>
</tool-use>

---

Confirmado. El código C# **NO** está enviando el parámetro `@EsCotizacion` pero el SP lo requiere.

**Tienes 2 opciones:**

## **Opción 1: Modificar el SP para hacer @EsCotizacion opcional (RECOMENDADO)**

```sql
-- Ver la definición actual completa del SP
SELECT OBJECT_DEFINITION(OBJECT_ID('dbo.Facturas_GuardarFactura'))
```

Ejecuta esto primero para ver el SP completo, pero probablemente necesitas modificarlo así:

```sql
ALTER PROCEDURE [dbo].[Facturas_GuardarFactura]
	@Fecha datetime, 
	@IdNotaPedido int,
	@IdCliente int,
	@NumeroFactura bigint,
	@Observaciones varchar(500),
	@DescuentoEspecial int,
	@ValorDolar float,
	@EsNotaDeCredito bit,
	@EsCotizacion bit = 0  -- ⚠️ AGREGAR VALOR POR DEFECTO
AS
BEGIN
	-- (el resto del SP)
END
```

## **Opción 2: Modificar el código C# para enviar el parámetro**

Necesitarías agregar una propiedad `EsCotizacion` a la clase `Factura` y enviarla en el método `Guardar()`.

---

**¿Cuál prefieres?** Primero ejecuta este query para ver el SP completo:

```sql
SELECT OBJECT_DEFINITION(OBJECT_ID('dbo.Facturas_GuardarFactura'))
```

Y dime: ¿las facturas en tu sistema pueden ser cotizaciones? ¿O eso es una funcionalidad que se agregó pero nunca se implementó en el código?

---

