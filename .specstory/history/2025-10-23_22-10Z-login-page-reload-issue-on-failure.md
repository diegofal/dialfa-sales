<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 01116bbc-6695-43d5-9a2c-bf3d938dc602 (2025-10-23 22:10Z) -->

# Login page reload issue on failure (2025-10-23 22:10Z)

_**User (2025-10-23 21:07Z)**_

when login fails ,the login page is reloaded incorrectly. 

---

_**Agent (model claude-4.5-sonnet-thinking, mode Agent)**_

<think><details><summary>Thought Process</summary>
The user is reporting a bug where the login page is reloaded incorrectly when login fails. Let me investigate the login functionality to understand what's happening.

I should:
1. Look at the login page component
2. Look at the login API route
3. Understand what happens when login fails
4. Identify the issue causing incorrect reload

Let me start by reading the login page and the login API route.</details></think>

---

I'll investigate the login failure issue. Let me look at the login page and related API to understand what's happening when login fails.

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: d:\dialfa new\spisa-new\frontend\app\login\page.tsx</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: d:\dialfa new\spisa-new\frontend\app\api\auth\login\route.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: d:\dialfa new\spisa-new\frontend\middleware.ts</summary>

</details>
</tool-use>

---

Now let me check the useAuth hook to see how it handles login failures:

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: d:\dialfa new\spisa-new\frontend\lib\hooks\useAuth.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: d:\dialfa new\spisa-new\frontend\store\authStore.ts</summary>

</details>
</tool-use>

---

Let me also check the authApi to see how the login request is made:

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: d:\dialfa new\spisa-new\frontend\lib\api\auth.ts</summary>

</details>
</tool-use>

---

Now I've identified the issue. Let me trace through what happens when login fails:

1. User submits login form
2. `useLogin` mutation is called
3. If login fails (401 error from API), the `onError` in `useLogin` shows a toast
4. **The problem**: The login page has a `useEffect` that checks `isAuthenticated` and redirects to `/dashboard` if true. However, when login fails and the error response comes back, something might be triggering a page reload or navigation incorrectly.

Actually, looking more carefully at the code, I don't see an obvious cause for a page reload. Let me check if there's something in the API client that might be causing this:

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: d:\dialfa new\spisa-new\frontend\lib\api\client.ts</summary>

</details>
</tool-use>

---

**Found the issue!** The problem is in the API client's response interceptor at lines 28-31. When login fails with a 401 status, the interceptor automatically redirects to `/login` using `window.location.href = '/login'`, which causes a full page reload. This happens even when the user is already on the login page trying to authenticate.

The interceptor shouldn't redirect to login when:
1. The user is already on the login page
2. The request is to the login endpoint itself

Here's the fix:

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: d:\dialfa new\spisa-new\frontend\lib\api\client.ts</summary>

**Chunk 1**
Lines added: 8, lines removed: 2

```diff
@@ -27,6 +27,12 @@
    (error) =&gt; {
      if (error.response?.status === 401) {
-       // Token expired or invalid - redirect to login
-       window.location.href = '/login';
+       // Don't redirect if we're already on the login page or if this is a login attempt
+       const isLoginRequest = error.config?.url?.includes('/auth/login');
+       const isOnLoginPage = typeof window !== 'undefined' &amp;&amp; window.location.pathname === '/login';
+       
+       if (!isLoginRequest &amp;&amp; !isOnLoginPage) {
+         // Token expired or invalid - redirect to login
+         window.location.href = '/login';
+       }
      }
      return Promise.reject(error);
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
The user is reporting a bug where the login page is reloaded incorrectly when login fails. Let me investigate the login functionality to understand what's happening.

I should:
1. Look at the login page component
2. Look at the login API route
3. Understand what happens when login fails
4. Identify the issue causing incorrect reload

Let me start by reading the login page and the login API route.</details></think>

---

Perfect! I found and fixed the issue. The problem was in the API client's response interceptor. When login failed with a 401 error, the interceptor was automatically redirecting to `/login` using `window.location.href`, which caused a full page reload even though the user was already on the login page.

## The Issue

The axios response interceptor in `client.ts` was catching **all** 401 errors (including failed login attempts) and redirecting to the login page with a full page reload:

```typescript:24:34:d:\dialfa new\spisa-new\frontend\lib\api\client.ts
// Response interceptor to handle errors
apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // Don't redirect if we're already on the login page or if this is a login attempt
      const isLoginRequest = error.config?.url?.includes('/auth/login');
      const isOnLoginPage = typeof window !== 'undefined' && window.location.pathname === '/login';
      
      if (!isLoginRequest && !isOnLoginPage) {
        // Token expired or invalid - redirect to login
```

## The Fix

Now the interceptor checks:
1. If the 401 error is from the login endpoint itself (`/auth/login`)
2. If the user is already on the login page

If either condition is true, it **doesn't redirect**, allowing the error to propagate normally to the `onError` handler in `useLogin`, which shows a proper toast notification.

The interceptor only redirects when:
- A 401 occurs from a protected API endpoint (expired/invalid token)
- The user is NOT on the login page

This allows proper error handling for failed login attempts while still protecting against expired sessions.

---

