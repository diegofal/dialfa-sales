<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 1618022a-293d-49f5-b0d3-d897557163f9 (2025-12-26 11:28Z) -->

# Query de facturas y artículos (2025-12-26 11:28Z)

_**User (2025-12-25 19:29Z)**_

traduci esta query al modelo actual: "select * from facturas f
inner join NotaPedidos np on np.IdNotaPedido = f.IdNotaPedido
inner join NotaPedido_Items npi on npi.IdNotaPedido = np.IdNotaPedido
where f.FueImpresa=1 and npi.IdArticulo=(select IdArticulo from articulos where codigo='BCS3003/4')
order by fecha desc "

---

_**Agent (model claude-4.5-opus-high-thinking, mode Agent)**_

<think><details><summary>Thought Process</summary>
The user wants me to translate a SQL query to the current model in their codebase. This seems to be related to a database schema they're working with. I need to understand what "modelo actual" (current model) means - it likely refers to their ORM models or a different database schema.

Let me first search for the database models in their codebase to understand the current structure. I should look for models related to:
- facturas (invoices)
- NotaPedidos (order notes)
- NotaPedido_Items (order note items)
- articulos (articles)

Let me search for these in the spisa-new or spisa projects since those seem to be the main applications.</details></think>

---

Primero necesito entender el modelo actual de tu base de datos. Déjame buscar los modelos relacionados con facturas, nota de pedidos y artículos.

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">

</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">

</tool-use>

---

<think><details><summary>Thought Process</summary>
Let me try grep to find these models.</details></think>

---

Search failed: rg: .\frontend\nul: Incorrect function. (os error 1) (exit 2, root: d:/dialfa new/spisa-new)

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "class.*Factura|class.*NotaPedido|class.*Articulo" in "D:/dialfa new/spisa-new" • 17 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `.\frontend\app\dashboard\invoices\[id]\page.tsx` | `<p className="text-muted-foreground">Cargando factura...</p>` | L129 |
| `.\frontend\app\dashboard\invoices\[id]\page.tsx` | `<p className="text-muted-foreground">Factura no encontrada</p>` | L137 |
| `.\frontend\app\dashboard\invoices\[id]\page.tsx` | `<h1 className="text-3xl font-bold">Factura \{invoice.invoiceNumber\}</h1>` | L268 |
| `.\frontend\app\dashboard\invoices\[id]\page.tsx` | `<CardTitle className="text-destructive">Factura Cancelada</CardTitle>` | L472 |
| `.\frontend\app\dashboard\sales-orders\[id]\edit\page.tsx` | `<p className="max-w-xs">Este pedido tiene una factura impresa. No se pueden realizar modificaciones. El stock ya fue debitado y el movimiento contable fue registrado.</p>` | L50 |
| `.\frontend\app\dashboard\sales-orders\[id]\edit\page.tsx` | `<Badge variant="default" className="bg-blue-600 cursor-help">Con Factura</Badge>` | L60 |
| `.\tools\spisa-migration\models\legacy.py` | `class LegacyArticulo:` | L15 |
| `.\tools\spisa-migration\models\legacy.py` | `class LegacyNotaPedido:` | L58 |
| `.\tools\spisa-migration\models\legacy.py` | `class LegacyNotaPedidoItem:` | L69 |
| `.\tools\spisa-migration\models\legacy.py` | `class LegacyFactura:` | L78 |
| `.\frontend\app\dashboard\invoices\page.tsx` | `<h1 className="text-3xl font-bold tracking-tight">Facturas</h1>` | L119 |
| `.\frontend\app\dashboard\invoices\page.tsx` | `<p className="text-muted-foreground">Gestiona las facturas del sistema</p>` | L120 |
| `.\frontend\app\dashboard\invoices\page.tsx` | `<CardTitle className="text-sm font-medium">Total Facturas</CardTitle>` | L132 |
| `.\frontend\app\dashboard\sales-orders\page.tsx` | `<CardTitle className="text-sm font-medium">Facturados</CardTitle>` | L116 |
| `.\frontend\app\dashboard\invoices\new\page.tsx` | `<h1 className="text-3xl font-bold">Nueva Factura</h1>` | L79 |
| `.\frontend\app\dashboard\invoices\new\page.tsx` | `<p className="text-muted-foreground">Crear una nueva factura desde un pedido</p>` | L80 |
| `.\MIGRATION_PLAN.md` | `public class CreateArticuloCommandHandlerTests` | L1188 |


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Encontré modelos legacy y también hay referencias a modelos actuales. Déjame revisar los modelos legacy y también buscar los modelos actuales (probablemente en una carpeta de backend).</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: D:/dialfa new/spisa-new/tools/spisa-migration/models/legacy.py</summary>

</details>
</tool-use>

---

Model provided non-existent directory

---

<think><details><summary>Thought Process</summary>
No hay un directorio backend como tal. Déjame explorar la estructura del proyecto para ver dónde está el modelo actual.</details></think>

---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_dir** • Listed directory, 0 results</summary>
        
No results found
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Veo que hay un schema de Prisma. Vamos a leerlo para ver el modelo actual.</details></think>

---

El modelo actual parece estar en Prisma. Déjame revisar el schema.

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: D:/dialfa new/spisa-new/frontend/prisma/schema.prisma</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
Ahora tengo claro el modelo actual. El usuario quiere traducir esta query SQL legacy:

```sql
select * from facturas f
inner join NotaPedidos np on np.IdNotaPedido = f.IdNotaPedido
inner join NotaPedido_Items npi on npi.IdNotaPedido = np.IdNotaPedido
where f.FueImpresa=1 and npi.IdArticulo=(select IdArticulo from articulos where codigo='BCS3003/4')
order by fecha desc
```

Al modelo actual que usa:
- `invoices` en lugar de `facturas`
- `sales_orders` en lugar de `NotaPedidos`
- `sales_order_items` en lugar de `NotaPedido_Items`
- `articles` en lugar de `articulos`
- `is_printed` en lugar de `FueImpresa`
- `invoice_date` en lugar de `fecha`
- `article_id` en lugar de `IdArticulo`
- `code` en lugar de `codigo`
- `sales_order_id` en lugar de `IdNotaPedido`

Lo que la query busca es: Todas las facturas impresas que tienen un artículo con código 'BCS3003/4', ordenadas por fecha descendente.

Voy a traducirla a SQL PostgreSQL con el nuevo esquema.</details></think>

---

Ahora tengo claro el modelo. Aquí está la traducción:

## Query Original (Legacy SQL Server)
```sql
SELECT * FROM facturas f
INNER JOIN NotaPedidos np ON np.IdNotaPedido = f.IdNotaPedido
INNER JOIN NotaPedido_Items npi ON npi.IdNotaPedido = np.IdNotaPedido
WHERE f.FueImpresa = 1 AND npi.IdArticulo = (SELECT IdArticulo FROM articulos WHERE codigo = 'BCS3003/4')
ORDER BY fecha DESC
```

## Query Traducida (Modelo actual PostgreSQL/Prisma)

```sql
SELECT i.*, so.*, soi.*
FROM invoices i
INNER JOIN sales_orders so ON so.id = i.sales_order_id
INNER JOIN sales_order_items soi ON soi.sales_order_id = so.id
WHERE i.is_printed = true 
  AND soi.article_id = (SELECT id FROM articles WHERE code = 'BCS3003/4')
ORDER BY i.invoice_date DESC;
```

## Mapeo de entidades:

| Legacy | Modelo Actual |
|--------|---------------|
| `facturas` | `invoices` |
| `NotaPedidos` | `sales_orders` |
| `NotaPedido_Items` | `sales_order_items` |
| `articulos` | `articles` |
| `IdNotaPedido` | `sales_order_id` / `id` |
| `IdArticulo` | `article_id` / `id` |
| `FueImpresa` | `is_printed` |
| `codigo` | `code` |
| `fecha` | `invoice_date` |

---

**Nota**: Si lo necesitas en Prisma (TypeScript), sería algo como:

```typescript
const result = await prisma.invoices.findMany({
  where: {
    is_printed: true,
    sales_orders: {
      sales_order_items: {
        some: {
          articles: {
            code: 'BCS3003/4'
          }
        }
      }
    }
  },
  include: {
    sales_orders: {
      include: {
        sales_order_items: {
          where: {
            articles: {
              code: 'BCS3003/4'
            }
          },
          include: {
            articles: true
          }
        }
      }
    }
  },
  orderBy: {
    invoice_date: 'desc'
  }
});
```

¿Necesitas que ajuste algo o que lo adapte a un caso de uso específico?

---

