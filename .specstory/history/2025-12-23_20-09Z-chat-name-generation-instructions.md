<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session fd398fe9-aaa5-45c5-a476-8edd541d7bcd (2025-12-23 20:09Z) -->

# Chat name generation instructions (2025-12-23 20:09Z)

_**User (2025-12-23 15:16Z)**_

el formulario de pedidos debe tener una apariencia similar al de facturas para que se vea bien que es cada campo 

---

_**Agent (model gemini-3-flash-preview, mode Agent)**_

<think><details><summary>Thought Process</summary>
**Examining Form Designs**

I'm currently reviewing the frontend code. My objective is to align the appearance of the "pedidos" form with the existing "facturas" form. I'm focusing on their implementation details to ensure a consistent user interface. The goal is to accurately mimic the styling of the invoices form within the orders form.


**Identifying Code Components**

I've begun delving into the frontend directory, searching for "pedidos" and "facturas" within the codebase. My initial assessment indicates the components are likely within the `d:\dial fa new\spisa-new\frontend\` directory. I'm now cross-referencing file structures to pinpoint the styling and implementation details that govern the "facturas" form, hoping to mirror them in the "pedidos" form.


</details></think>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">

</tool-use>

---

<think><details><summary>Thought Process</summary>
**Analyzing Search Failures**

I'm frustrated. The semantic search yielded nothing useful. Time to get my hands dirty. I'll use `grep` to hunt down "pedidos" and "facturas" in the frontend directory. I'll also try broader terms like "OrderForm" and "InvoiceForm". Let's see if this old-school approach unearths anything of value.


</details></think>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** ‚Ä¢ Grep for "SalesOrder|Invoice|Pedido|Factura" in "d:\dialfa new\spisa-new\frontend\" ‚Ä¢ 583 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `import \{ useCreateSalesOrder, useGenerateInvoice, useGenerateDeliveryNote \} from '@/lib/hooks/useSalesOrders';` | L8 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `import \{ useSalesOrder, useUpdateSalesOrder, useDeleteSalesOrder \} from '@/lib/hooks/useSalesOrders';` | L16 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `import \{ useSalesOrderPermissions \} from '@/lib/hooks/useSalesOrderPermissions';` | L17 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `import \{ validateSalesOrder \} from '@/lib/permissions/salesOrders';` | L18 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `const \{ data: existingOrder, isLoading: isLoadingOrder, error: orderError \} = useSalesOrder(orderId \|\| 0);` | L54 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `const permissions = useSalesOrderPermissions(existingOrder, hasUnsavedChanges);` | L71 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `const createOrderMutation = useCreateSalesOrder();` | L124 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `const updateOrderMutation = useUpdateSalesOrder();` | L125 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `const deleteOrderMutation = useDeleteSalesOrder();` | L126 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `const generateInvoiceMutation = useGenerateInvoice();` | L127 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `const hasUnprintedInvoice = existingOrder.invoice && !existingOrder.invoice.isPrinted && !existingOrder.invoice.isCancelled;` | L180 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `if (hasUnprintedInvoice \|\| hasUnprintedDeliveryNote) \{` | L183 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `invoice: !!hasUnprintedInvoice,` | L185 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `<p className="text-muted-foreground">Pedido no encontrado</p>` | L333 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `const validation = validateSalesOrder(` | L599 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `const handleGenerateInvoice = async () => \{` | L693 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `const invoice = await generateInvoiceMutation.mutateAsync(\{ id: orderId \});` | L705 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `\{permissions.canCreateInvoice && (!existingOrder?.invoice \|\| existingOrder.invoice.isCancelled) && (` | L1148 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `onClick=\{handleGenerateInvoice\}` | L1151 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `disabled=\{generateInvoiceMutation.isPending\}` | L1152 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `\{generateInvoiceMutation.isPending ? 'Generando...' : 'Generar Factura'\}` | L1155 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `Ver Factura` | L1164 |
| `frontend/components\salesOrders\SingleStepOrderForm.tsx` | `\{createOrderMutation.isPending ? 'Creando...' : 'Crear Pedido'\}` | L1183 |
| `frontend/lib\hooks\useQuickCartTabs.ts` | `name: `Pedido $\{state.tabs.length + 1\}`,` | L119 |
| `frontend/lib\hooks\useQuickCartTabs.ts` | `const tabName = tabIndex >= 0 ? `Pedido $\{tabIndex + 1\}` : 'Pedido';` | L180 |
| `frontend/lib\hooks\useQuickCartTabs.ts` | `const tabName = tabIndex >= 0 ? `Pedido $\{tabIndex + 1\}` : 'Pedido';` | L200 |
| `frontend/lib\hooks\useQuickCartTabs.ts` | `const tabName = tabIndex >= 0 ? `Pedido $\{tabIndex + 1\}` : 'Pedido';` | L399 |
| `frontend/lib\utils\mapper.ts` | `export function mapSalesOrderToDTO(order: unknown) \{` | L101 |
| `frontend/lib\utils\mapper.ts` | `hasInvoice: !!invoice && !(invoice.is_cancelled as boolean),` | L126 |
| `frontend/lib\utils\mapper.ts` | `export function mapInvoiceToDTO(invoice: unknown) \{` | L167 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `import \{ useInvoice, useCancelInvoice, usePrintInvoice, useUpdateInvoiceExchangeRate, useInvoiceStockMovements \} from '@/lib/hooks/useInvoices';` | L18 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `import \{ useQuickInvoiceTabs \} from '@/lib/hooks/useQuickInvoiceTabs';` | L19 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `export default function InvoiceDetailPage() \{` | L33 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `const \{ data: invoice, isLoading \} = useInvoice(invoiceId);` | L38 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `const \{ data: stockMovements, isLoading: isLoadingMovements \} = useInvoiceStockMovements(invoiceId);` | L39 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `const cancelInvoiceMutation = useCancelInvoice();` | L40 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `const printInvoiceMutation = usePrintInvoice();` | L41 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `const updateExchangeRateMutation = useUpdateInvoiceExchangeRate();` | L42 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `const \{ addInvoiceTab \} = useQuickInvoiceTabs();` | L43 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `addInvoiceTab(invoice.id, invoice.invoiceNumber, invoice.clientBusinessName);` | L54 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `<p className="text-muted-foreground">Factura no encontrada</p>` | L78 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `cancelInvoiceMutation.mutate(` | L110 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `printInvoiceMutation.mutate(invoiceId);` | L121 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `<h1 className="text-3xl font-bold">Factura \{invoice.invoiceNumber\}</h1>` | L223 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `\{/* Invoice Information */\}` | L254 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `<CardTitle>Informaci√≥n de la Factura</CardTitle>` | L257 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `<p className="text-sm text-muted-foreground">Pedido N¬∞</p>` | L261 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `<CardTitle className="text-destructive">Factura Cancelada</CardTitle>` | L421 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `Cancelar Factura` | L527 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `Ver Pedido` | L569 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `<Button onClick=\{handlePrint\} disabled=\{printInvoiceMutation.isPending\}>` | L579 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `\{printInvoiceMutation.isPending ? 'Imprimiendo...' : 'Imprimir'\}` | L581 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `disabled=\{cancelInvoiceMutation.isPending\}` | L607 |
| `frontend/app\dashboard\invoices\[id]\page.tsx` | `\{cancelInvoiceMutation.isPending ? 'Cancelando...' : 'S√≠, cancelar factura'\}` | L609 |
| `frontend/app\api\invoices\[id]\items\route.ts` | `import \{ mapInvoiceToDTO \} from '@/lib/utils/mapper';` | L3 |
| `frontend/app\api\invoices\[id]\items\route.ts` | `const updateInvoiceItemsSchema = z.object(\{` | L6 |
| `frontend/app\api\invoices\[id]\items\route.ts` | `const validatedData = updateInvoiceItemsSchema.parse(body);` | L22 |
| `frontend/app\api\invoices\[id]\items\route.ts` | `return NextResponse.json(\{ error: 'Invoice not found' \}, \{ status: 404 \});` | L30 |
| `frontend/app\api\invoices\[id]\items\route.ts` | `const updatedInvoice = await prisma.$transaction(async (tx) => \{` | L45 |
| `frontend/app\api\invoices\[id]\items\route.ts` | `const mappedInvoice = mapInvoiceToDTO(updatedInvoice);` | L96 |
| `frontend/app\api\invoices\[id]\items\route.ts` | `return NextResponse.json(mappedInvoice);` | L97 |
| `frontend/lib\hooks\useSalesOrders.ts` | `import type \{ CreateSalesOrderRequest, UpdateSalesOrderRequest, SalesOrderUpdateResponse \} from '@/types/salesOrder';` | L4 |
| `frontend/lib\hooks\useSalesOrders.ts` | `import type \{ Invoice \} from '@/types/invoice';` | L5 |
| `frontend/lib\hooks\useSalesOrders.ts` | `import \{ useQuickInvoiceTabs \} from './useQuickInvoiceTabs';` | L8 |
| `frontend/lib\hooks\useSalesOrders.ts` | `export const useSalesOrders = (params: PaginationParams & \{` | L11 |
| `frontend/lib\hooks\useSalesOrders.ts` | `export const useSalesOrder = (id: number, options?: \{ enabled?: boolean \}) => \{` | L24 |
| `frontend/lib\hooks\useSalesOrders.ts` | `export const useCreateSalesOrder = () => \{` | L42 |
| `frontend/lib\hooks\useSalesOrders.ts` | `mutationFn: (data: CreateSalesOrderRequest) => salesOrdersApi.create(data),` | L46 |
| `frontend/lib\hooks\useSalesOrders.ts` | `toast.success('Pedido creado exitosamente');` | L49 |
| `frontend/lib\hooks\useSalesOrders.ts` | `export const useUpdateSalesOrder = () => \{` | L58 |
| `frontend/lib\hooks\useSalesOrders.ts` | `return useMutation<SalesOrderUpdateResponse, Error, \{ id: number; data: UpdateSalesOrderRequest \}>(\{` | L61 |
| `frontend/lib\hooks\useSalesOrders.ts` | `mutationFn: (\{ id, data \}: \{ id: number; data: UpdateSalesOrderRequest \}) =>` | L62 |
| `frontend/lib\hooks\useSalesOrders.ts` | `toast.success('Pedido actualizado exitosamente');` | L78 |
| `frontend/lib\hooks\useSalesOrders.ts` | `export const useCancelSalesOrder = () => \{` | L95 |
| `frontend/lib\hooks\useSalesOrders.ts` | `toast.success('Pedido cancelado exitosamente');` | L102 |
| `frontend/lib\hooks\useSalesOrders.ts` | `export const useDeleteSalesOrder = () => \{` | L111 |
| `frontend/lib\hooks\useSalesOrders.ts` | `const \{ removeTabByInvoiceId \} = useQuickInvoiceTabs();` | L113 |
| `frontend/lib\hooks\useSalesOrders.ts` | `if (data.affectedInvoices && data.affectedInvoices.length > 0) \{` | L120 |
| `frontend/lib\hooks\useSalesOrders.ts` | `data.affectedInvoices.forEach(invoice => \{` | L121 |
| `frontend/lib\hooks\useSalesOrders.ts` | `removeTabByInvoiceId(parseInt(invoice.id));` | L122 |
| `frontend/lib\hooks\useSalesOrders.ts` | `let message = `Pedido $\{data.orderNumber \|\| ''\} eliminado exitosamente`;` | L139 |
| `frontend/lib\hooks\useSalesOrders.ts` | `if (data.affectedInvoices && data.affectedInvoices.length > 0) \{` | L141 |
| `frontend/lib\hooks\useSalesOrders.ts` | `const cancelledCount = data.affectedInvoices.filter(inv => inv.wasCancelled).length;` | L142 |
| `frontend/lib\hooks\useSalesOrders.ts` | `const deletedCount = data.affectedInvoices.filter(inv => !inv.wasCancelled).length;` | L143 |
| `frontend/lib\hooks\useSalesOrders.ts` | `export const useGenerateInvoice = () => \{` | L166 |
| `frontend/lib\hooks\useSalesOrders.ts` | `salesOrdersApi.generateInvoice(id, usdExchangeRate),` | L171 |
| `frontend/lib\hooks\useSalesOrders.ts` | `onSuccess: (invoice: Invoice) => \{` | L172 |
| `frontend/lib\hooks\useSalesOrders.ts` | `toast.success(`Factura $\{invoice.invoiceNumber\} generada exitosamente`);` | L175 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `import \{ mapSalesOrderToDTO \} from '@/lib/utils/mapper';` | L3 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `import \{ updateSalesOrderSchema \} from '@/lib/validations/schemas';` | L4 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `const mappedSalesOrder = mapSalesOrderToDTO(salesOrder);` | L68 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `return NextResponse.json(mappedSalesOrder);` | L70 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `const existingSalesOrder = await prisma.sales_orders.findUnique(\{` | L90 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `if (!existingSalesOrder \|\| existingSalesOrder.deleted_at) \{` | L106 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `const activeInvoice = existingSalesOrder.invoices[0];` | L115 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `if (activeInvoice && activeInvoice.is_printed && !activeInvoice.is_cancelled) \{` | L116 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `const validatedData = updateSalesOrderSchema.parse(body);` | L124 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `const unprintedInvoices = await prisma.invoices.findMany(\{` | L129 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `for (const invoice of unprintedInvoices) \{` | L201 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `const newInvoiceItems = createdItems.map((item) => \{` | L214 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `data: newInvoiceItems,` | L245 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `const updateInfo = (unprintedInvoices.length > 0 \|\| unprintedDeliveryNotes.length > 0) ? \{` | L309 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `invoices: unprintedInvoices.length,` | L310 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `message: `Se actualizaron autom√°ticamente $\{unprintedInvoices.length\} factura(s) y $\{unprintedDeliveryNotes.length\} remito(s) no impreso(s)`,` | L312 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `const serializedSalesOrder = \{` | L316 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `return NextResponse.json(serializedSalesOrder);` | L338 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `const serializedSalesOrder = \{` | L361 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `return NextResponse.json(serializedSalesOrder);` | L382 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `const existingSalesOrder = await prisma.sales_orders.findUnique(\{` | L410 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `if (!existingSalesOrder \|\| existingSalesOrder.deleted_at) \{` | L428 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `const affectedInvoiceIds: string[] = [];` | L438 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `const cancelledInvoices: Array<\{ id: string; invoiceNumber: string; wasCancelled: boolean \}> = [];` | L440 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `for (const invoice of existingSalesOrder.invoices) \{` | L445 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `affectedInvoiceIds.push(invoice.id.toString());` | L446 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `cancellation_reason: 'Pedido eliminado',` | L460 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `cancelledInvoices.push(\{` | L465 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `for (const item of existingSalesOrder.sales_order_items) \{` | L472 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `reference_document: `Cancelaci√≥n factura $\{invoice.invoice_number\} - Pedido eliminado`,` | L479 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `notes: `Stock devuelto por cancelaci√≥n de factura al eliminar pedido $\{existingSalesOrder.order_number\}`,` | L481 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `cancelledInvoices.push(\{` | L508 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `for (const deliveryNote of existingSalesOrder.delivery_notes) \{` | L517 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `affectedInvoices: cancelledInvoices,` | L547 |
| `frontend/app\api\sales-orders\[id]\route.ts` | `orderNumber: existingSalesOrder.order_number,` | L549 |
| `frontend/types\salesOrder.ts` | `export interface SalesOrder \{` | L1 |
| `frontend/types\salesOrder.ts` | `items?: SalesOrderItem[];` | L16 |
| `frontend/types\salesOrder.ts` | `export interface SalesOrderUpdateResponse extends SalesOrder \{` | L31 |
| `frontend/types\salesOrder.ts` | `export interface SalesOrderItem \{` | L39 |
| `frontend/types\salesOrder.ts` | `export interface SalesOrderListDto \{` | L51 |
| `frontend/types\salesOrder.ts` | `hasInvoice: boolean;` | L61 |
| `frontend/types\salesOrder.ts` | `export interface CreateSalesOrderRequest \{` | L65 |
| `frontend/types\salesOrder.ts` | `items: CreateSalesOrderItemRequest[];` | L68 |
| `frontend/types\salesOrder.ts` | `export interface CreateSalesOrderItemRequest \{` | L71 |
| `frontend/types\salesOrder.ts` | `export interface UpdateSalesOrderRequest \{` | L78 |
| `frontend/types\salesOrder.ts` | `items: UpdateSalesOrderItemRequest[];` | L81 |
| `frontend/types\salesOrder.ts` | `export interface UpdateSalesOrderItemRequest \{` | L84 |
| `frontend/types\salesOrder.ts` | `export interface SalesOrderFormData \{` | L93 |
| `frontend/types\salesOrder.ts` | `items: SalesOrderItemFormData[];` | L98 |
| `frontend/types\salesOrder.ts` | `export interface SalesOrderItemFormData \{` | L101 |
| `frontend/lib\api\salesOrders.ts` | `SalesOrder,` | L4 |
| `frontend/lib\api\salesOrders.ts` | `SalesOrderListDto,` | L5 |
| `frontend/lib\api\salesOrders.ts` | `CreateSalesOrderRequest,` | L6 |
| `frontend/lib\api\salesOrders.ts` | `UpdateSalesOrderRequest,` | L7 |
| `frontend/lib\api\salesOrders.ts` | `SalesOrderUpdateResponse` | L8 |
| `frontend/lib\api\salesOrders.ts` | `import type \{ Invoice \} from '@/types/invoice';` | L10 |
| `frontend/lib\api\salesOrders.ts` | `import type \{ SalesOrderStatus, SalesOrderPermissions \} from '@/types/permissions';` | L12 |
| `frontend/lib\api\salesOrders.ts` | `\} = \{}): Promise<PagedResult<SalesOrderListDto>> => \{` | L21 |
| `frontend/lib\api\salesOrders.ts` | `const \{ data \} = await apiClient.get<PagedResult<SalesOrderListDto>>('/sales-orders', \{` | L29 |
| `frontend/lib\api\salesOrders.ts` | `getById: async (id: number): Promise<SalesOrder> => \{` | L36 |
| `frontend/lib\api\salesOrders.ts` | `const \{ data \} = await apiClient.get<SalesOrder>(`/sales-orders/$\{id\}`);` | L37 |
| `frontend/lib\api\salesOrders.ts` | `create: async (orderData: CreateSalesOrderRequest): Promise<\{ id: number \}> => \{` | L41 |
| `frontend/lib\api\salesOrders.ts` | `update: async (id: number, orderData: UpdateSalesOrderRequest): Promise<SalesOrderUpdateResponse> => \{` | L46 |
| `frontend/lib\api\salesOrders.ts` | `const \{ data \} = await apiClient.put<SalesOrderUpdateResponse>(`/sales-orders/$\{id\}`, orderData);` | L47 |
| `frontend/lib\api\salesOrders.ts` | `affectedInvoices?: Array<\{ id: string; invoiceNumber: string; wasCancelled: boolean \}>;` | L57 |
| `frontend/lib\api\salesOrders.ts` | `status: SalesOrderStatus;` | L66 |
| `frontend/lib\api\salesOrders.ts` | `permissions: SalesOrderPermissions` | L67 |
| `frontend/lib\api\salesOrders.ts` | `generateInvoice: async (id: number, usdExchangeRate?: number): Promise<Invoice> => \{` | L73 |
| `frontend/lib\api\salesOrders.ts` | `const \{ data \} = await apiClient.post<Invoice>(`/sales-orders/$\{id\}/generate-invoice`, \{` | L74 |
| `frontend/components\layout\Sidebar.tsx` | `import PedidosMenuItem from './PedidosMenuItem';` | L16 |
| `frontend/components\layout\Sidebar.tsx` | `import FacturasMenuItem from './FacturasMenuItem';` | L17 |
| `frontend/components\layout\Sidebar.tsx` | `\{/* Pedidos with expandable sub-items */\}` | L61 |
| `frontend/components\layout\Sidebar.tsx` | `<PedidosMenuItem />` | L62 |
| `frontend/components\layout\Sidebar.tsx` | `\{/* Facturas with expandable sub-items */\}` | L64 |
| `frontend/components\layout\Sidebar.tsx` | `<FacturasMenuItem />` | L65 |
| `frontend/app\api\sales-orders\route.ts` | `import \{ mapSalesOrderToDTO \} from '@/lib/utils/mapper';` | L3 |
| `frontend/app\api\sales-orders\route.ts` | `import \{ createSalesOrderSchema \} from '@/lib/validations/schemas';` | L4 |
| `frontend/app\api\sales-orders\route.ts` | `const mappedSalesOrders = salesOrders.map(mapSalesOrderToDTO);` | L75 |
| `frontend/app\api\sales-orders\route.ts` | `data: mappedSalesOrders,` | L78 |
| `frontend/app\api\sales-orders\route.ts` | `const validatedData = createSalesOrderSchema.parse(body);` | L100 |
| `frontend/app\api\sales-orders\route.ts` | `const mappedSalesOrder = mapSalesOrderToDTO(result);` | L200 |
| `frontend/app\api\sales-orders\route.ts` | `return NextResponse.json(mappedSalesOrder, \{ status: 201 \});` | L202 |
| `frontend/app\api\invoices\route.ts` | `import \{ mapInvoiceToDTO \} from '@/lib/utils/mapper';` | L3 |
| `frontend/app\api\invoices\route.ts` | `import \{ createInvoiceSchema \} from '@/lib/validations/schemas';` | L4 |
| `frontend/app\api\invoices\route.ts` | `const mappedInvoices = invoices.map(mapInvoiceToDTO);` | L55 |
| `frontend/app\api\invoices\route.ts` | `data: mappedInvoices,` | L58 |
| `frontend/app\api\invoices\route.ts` | `const validatedData = createInvoiceSchema.parse(body);` | L80 |
| `frontend/app\api\invoices\route.ts` | `const todayInvoicesCount = await prisma.invoices.count(\{` | L145 |
| `frontend/app\api\invoices\route.ts` | `const sequence = String(todayInvoicesCount + 1).padStart(4, '0');` | L154 |
| `frontend/app\api\invoices\route.ts` | `const mappedInvoice = mapInvoiceToDTO(result);` | L252 |
| `frontend/app\api\invoices\route.ts` | `return NextResponse.json(mappedInvoice, \{ status: 201 \});` | L254 |
| `frontend/app\api\invoices\[id]\print\route.ts` | `\{ error: 'Invoice not found' \},` | L39 |
| `frontend/app\api\invoices\[id]\print\route.ts` | `const pdfBuffer = await pdfService.generateInvoicePDF(` | L53 |
| `frontend/app\api\invoices\[id]\cancel\route.ts` | `const existingInvoice = await prisma.invoices.findUnique(\{` | L14 |
| `frontend/app\api\invoices\[id]\cancel\route.ts` | `if (!existingInvoice \|\| existingInvoice.deleted_at) \{` | L18 |
| `frontend/app\api\invoices\[id]\cancel\route.ts` | `\{ error: 'Invoice not found' \},` | L20 |
| `frontend/app\api\invoices\[id]\cancel\route.ts` | `if (existingInvoice.is_cancelled) \{` | L26 |
| `frontend/app\api\invoices\[id]\cancel\route.ts` | `\{ error: 'Invoice is already cancelled' \},` | L28 |
| `frontend/app\api\invoices\[id]\cancel\route.ts` | `const isCancellingPrintedInvoice = existingInvoice.is_printed;` | L34 |
| `frontend/app\api\invoices\[id]\cancel\route.ts` | `if (isCancellingPrintedInvoice) \{` | L39 |
| `frontend/app\api\invoices\[id]\cancel\route.ts` | `where: \{ id: existingInvoice.sales_order_id \},` | L42 |
| `frontend/app\api\invoices\[id]\cancel\route.ts` | `reference_document: `Cancelaci√≥n factura $\{existingInvoice.invoice_number\}`,` | L56 |
| `frontend/app\api\invoices\[id]\cancel\route.ts` | `where: \{ id: existingInvoice.sales_order_id \},` | L91 |
| `frontend/app\api\invoices\[id]\cancel\route.ts` | `where: \{ id: existingInvoice.sales_order_id \},` | L105 |
| `frontend/app\api\invoices\[id]\cancel\route.ts` | `\{ message: 'Invoice cancelled successfully' \},` | L115 |
| `frontend/types\pdf-data.ts` | `interface InvoiceItem \{` | L4 |
| `frontend/types\pdf-data.ts` | `interface SalesOrder \{` | L25 |
| `frontend/types\pdf-data.ts` | `sales_order_items?: InvoiceItem[];` | L27 |
| `frontend/types\pdf-data.ts` | `export interface InvoiceData \{` | L30 |
| `frontend/types\pdf-data.ts` | `sales_orders?: SalesOrder;` | L36 |
| `frontend/types\pdf-data.ts` | `sales_orders?: SalesOrder;` | L62 |
| `frontend/lib\validations\schemas.ts` | `export const createSalesOrderSchema = z.object(\{` | L69 |
| `frontend/lib\validations\schemas.ts` | `export const updateSalesOrderSchema = createSalesOrderSchema.partial().required(\{ clientId: true \});` | L79 |
| `frontend/lib\validations\schemas.ts` | `// Invoice Validation Schema` | L81 |
| `frontend/lib\validations\schemas.ts` | `export const createInvoiceSchema = z.object(\{` | L82 |
| `frontend/lib\validations\schemas.ts` | `export const updateInvoiceSchema = createInvoiceSchema.partial();` | L91 |
| `frontend/lib\validations\schemas.ts` | `export type SalesOrderItemInput = z.infer<typeof salesOrderItemSchema>;` | L129 |
| `frontend/lib\validations\schemas.ts` | `export type CreateSalesOrderInput = z.infer<typeof createSalesOrderSchema>;` | L130 |
| `frontend/lib\validations\schemas.ts` | `export type UpdateSalesOrderInput = z.infer<typeof updateSalesOrderSchema>;` | L131 |
| `frontend/lib\validations\schemas.ts` | `export type CreateInvoiceInput = z.infer<typeof createInvoiceSchema>;` | L132 |
| `frontend/lib\validations\schemas.ts` | `export type UpdateInvoiceInput = z.infer<typeof updateInvoiceSchema>;` | L133 |
| `frontend/lib\services\PDFService.ts` | `import \{ InvoiceData, DeliveryNoteData, PDFItem, PDFDeliveryNoteItem \} from '@/types/pdf-data';` | L3 |
| `frontend/lib\services\PDFService.ts` | `async generateInvoicePDF(` | L8 |
| `frontend/lib\services\PDFService.ts` | `invoice: InvoiceData,` | L9 |
| `frontend/lib\services\PDFService.ts` | `this.renderField(doc, template.fields.numeroFactura,` | L32 |
| `frontend/app\dashboard\delivery-notes\[id]\page.tsx` | `<p className="text-sm text-muted-foreground">Pedido N¬∞</p>` | L190 |
| `frontend/app\dashboard\delivery-notes\[id]\page.tsx` | `Ver Pedido` | L363 |
| `frontend/components\layout\PedidosMenuItem.tsx` | `export default function PedidosMenuItem() \{` | L27 |
| `frontend/components\layout\PedidosMenuItem.tsx` | `console.log('PedidosMenuItem tabs:', tabs);` | L34 |
| `frontend/components\layout\PedidosMenuItem.tsx` | `toast.success('Pedido eliminado', \{` | L72 |
| `frontend/components\layout\PedidosMenuItem.tsx` | `\{/* Main Pedidos Menu Item */\}` | L95 |
| `frontend/components\layout\PedidosMenuItem.tsx` | `Pedidos` | L106 |
| `frontend/types\permissions.ts` | `export interface SalesOrderStatus \{` | L2 |
| `frontend/types\permissions.ts` | `hasInvoice: boolean;` | L4 |
| `frontend/types\permissions.ts` | `export interface SalesOrderPermissions \{` | L11 |
| `frontend/types\permissions.ts` | `canCreateInvoice: boolean;` | L14 |
| `frontend/types\permissions.ts` | `export function calculateSalesOrderPermissions(` | L24 |
| `frontend/types\permissions.ts` | `status: SalesOrderStatus` | L25 |
| `frontend/types\permissions.ts` | `): SalesOrderPermissions \{` | L26 |
| `frontend/types\permissions.ts` | `const hasActiveInvoicePrinted = status.invoicePrinted && !status.invoiceCancelled;` | L29 |
| `frontend/types\permissions.ts` | `canEdit: !hasActiveInvoicePrinted,` | L33 |
| `frontend/types\permissions.ts` | `canSave: !hasActiveInvoicePrinted,` | L36 |
| `frontend/types\permissions.ts` | `canCreateInvoice:` | L39 |
| `frontend/types\permissions.ts` | `(!status.hasInvoice \|\| status.invoiceCancelled),` | L41 |
| `frontend/types\permissions.ts` | `canCancel: status.id !== null && !hasActiveInvoicePrinted,` | L44 |
| `frontend/types\permissions.ts` | `canDelete: status.id !== null && !hasActiveInvoicePrinted,` | L49 |
| `frontend/types\permissions.ts` | `// Invoice Permission Types` | L56 |
| `frontend/types\permissions.ts` | `export interface InvoiceStatus \{` | L57 |
| `frontend/types\permissions.ts` | `export interface InvoicePermissions \{` | L63 |
| `frontend/types\permissions.ts` | `export function calculateInvoicePermissions(` | L74 |
| `frontend/types\permissions.ts` | `status: InvoiceStatus` | L75 |
| `frontend/types\permissions.ts` | `): InvoicePermissions \{` | L76 |
| `frontend/lib\hooks\useInvoices.ts` | `import type \{ Invoice, InvoiceListDto, CreateInvoiceRequest, UpdateInvoiceRequest \} from '@/types/invoice';` | L3 |
| `frontend/lib\hooks\useInvoices.ts` | `export function useInvoices(` | L9 |
| `frontend/lib\hooks\useInvoices.ts` | `return useQuery<PagedResult<InvoiceListDto>>(\{` | L19 |
| `frontend/lib\hooks\useInvoices.ts` | `export function useInvoice(id: number) \{` | L25 |
| `frontend/lib\hooks\useInvoices.ts` | `return useQuery<Invoice>(\{` | L26 |
| `frontend/lib\hooks\useInvoices.ts` | `export function useCreateInvoice() \{` | L33 |
| `frontend/lib\hooks\useInvoices.ts` | `mutationFn: (data: CreateInvoiceRequest) => invoicesApi.create(data),` | L37 |
| `frontend/lib\hooks\useInvoices.ts` | `toast.success('Factura creada exitosamente');` | L41 |
| `frontend/lib\hooks\useInvoices.ts` | `export function useUpdateInvoice() \{` | L49 |
| `frontend/lib\hooks\useInvoices.ts` | `mutationFn: (\{ id, data \}: \{ id: number; data: UpdateInvoiceRequest \}) =>` | L53 |
| `frontend/lib\hooks\useInvoices.ts` | `toast.success('Factura actualizada exitosamente');` | L57 |
| `frontend/lib\hooks\useInvoices.ts` | `export function useCancelInvoice() \{` | L65 |
| `frontend/lib\hooks\useInvoices.ts` | `toast.success('Factura cancelada exitosamente');` | L74 |
| `frontend/lib\hooks\useInvoices.ts` | `export function usePrintInvoice() \{` | L82 |
| `frontend/lib\hooks\useInvoices.ts` | `toast.success('Factura marcada como impresa');` | L90 |
| `frontend/lib\hooks\useInvoices.ts` | `export function useDownloadInvoicePdf() \{` | L98 |
| `frontend/lib\hooks\useInvoices.ts` | `export function useNextInvoiceNumber() \{` | L110 |
| `frontend/lib\hooks\useInvoices.ts` | `export function useUpdateInvoiceExchangeRate() \{` | L117 |
| `frontend/lib\hooks\useInvoices.ts` | `export function useInvoiceStockMovements(invoiceId: number) \{` | L144 |
| `frontend/app\dashboard\sales-orders\[id]\edit\page.tsx` | `import \{ useSalesOrder \} from '@/lib/hooks/useSalesOrders';` | L10 |
| `frontend/app\dashboard\sales-orders\[id]\edit\page.tsx` | `import \{ useSalesOrderPermissions \} from '@/lib/hooks/useSalesOrderPermissions';` | L11 |
| `frontend/app\dashboard\sales-orders\[id]\edit\page.tsx` | `export default function EditSalesOrderPage() \{` | L19 |
| `frontend/app\dashboard\sales-orders\[id]\edit\page.tsx` | `const \{ data: existingOrder \} = useSalesOrder(orderId \|\| 0);` | L23 |
| `frontend/app\dashboard\sales-orders\[id]\edit\page.tsx` | `const permissions = useSalesOrderPermissions(existingOrder);` | L24 |
| `frontend/app\dashboard\sales-orders\[id]\edit\page.tsx` | `console.log('üîç EditSalesOrderPage render:', \{` | L26 |
| `frontend/app\dashboard\sales-orders\[id]\edit\page.tsx` | `Factura Impresa` | L46 |
| `frontend/app\dashboard\sales-orders\[id]\edit\page.tsx` | `<Badge variant="default" className="bg-blue-600 cursor-help">Con Factura</Badge>` | L60 |
| `frontend/app\dashboard\sales-orders\[id]\edit\page.tsx` | `<p>Pedido pendiente sin factura ni remito.</p>` | L93 |
| `frontend/app\dashboard\sales-orders\[id]\edit\page.tsx` | `\{orderId ? 'Editar Pedido' : 'Nuevo Pedido'\}` | L111 |
| `frontend/lib\hooks\useSalesOrderPermissions.ts` | `import type \{ SalesOrder \} from '@/types/salesOrder';` | L2 |
| `frontend/lib\hooks\useSalesOrderPermissions.ts` | `import type \{ SalesOrderPermissions \} from '@/types/permissions';` | L3 |
| `frontend/lib\hooks\useSalesOrderPermissions.ts` | `import \{ calculateSalesOrderPermissions \} from '@/lib/permissions/salesOrders';` | L4 |
| `frontend/lib\hooks\useSalesOrderPermissions.ts` | `* const permissions = useSalesOrderPermissions(salesOrder, hasUnsavedChanges);` | L15 |
| `frontend/lib\hooks\useSalesOrderPermissions.ts` | `export function useSalesOrderPermissions(` | L25 |
| `frontend/lib\hooks\useSalesOrderPermissions.ts` | `salesOrder: SalesOrder \| null \| undefined,` | L26 |
| `frontend/lib\hooks\useSalesOrderPermissions.ts` | `): SalesOrderPermissions \{` | L28 |
| `frontend/lib\hooks\useSalesOrderPermissions.ts` | `return calculateSalesOrderPermissions(salesOrder, hasUnsavedChanges);` | L30 |
| `frontend/lib\api\invoices.ts` | `Invoice,` | L4 |
| `frontend/lib\api\invoices.ts` | `InvoiceListDto,` | L5 |
| `frontend/lib\api\invoices.ts` | `CreateInvoiceRequest,` | L6 |
| `frontend/lib\api\invoices.ts` | `UpdateInvoiceRequest,` | L7 |
| `frontend/lib\api\invoices.ts` | `): Promise<PagedResult<InvoiceListDto>> => \{` | L21 |
| `frontend/lib\api\invoices.ts` | `const \{ data \} = await apiClient.get<PagedResult<InvoiceListDto>>('/invoices', \{` | L28 |
| `frontend/lib\api\invoices.ts` | `getById: async (id: number): Promise<Invoice> => \{` | L35 |
| `frontend/lib\api\invoices.ts` | `const \{ data \} = await apiClient.get<Invoice>(`/invoices/$\{id\}`);` | L36 |
| `frontend/lib\api\invoices.ts` | `create: async (invoiceData: CreateInvoiceRequest): Promise<\{ id: number \}> => \{` | L40 |
| `frontend/lib\api\invoices.ts` | `update: async (id: number, invoiceData: UpdateInvoiceRequest): Promise<void> => \{` | L45 |
| `frontend/app\api\sales-orders\[id]\generate-delivery-note\route.ts` | `\{ error: 'Pedido no encontrado' \},` | L35 |
| `frontend/app\api\invoices\[id]\stock-movements\route.ts` | `\{ error: 'Invoice not found' \},` | L26 |
| `frontend/components\layout\FacturasMenuItem.tsx` | `import \{ useQuickInvoiceTabs \} from '@/lib/hooks/useQuickInvoiceTabs';` | L14 |
| `frontend/components\layout\FacturasMenuItem.tsx` | `export default function FacturasMenuItem() \{` | L27 |
| `frontend/components\layout\FacturasMenuItem.tsx` | `const \{ tabs, removeTab, activeTabId, setActiveTab \} = useQuickInvoiceTabs();` | L30 |
| `frontend/components\layout\FacturasMenuItem.tsx` | `const isInvoiceDetailPage = pathname.match(/^\/dashboard\/invoices\/\d+$/);` | L35 |
| `frontend/components\layout\FacturasMenuItem.tsx` | `toast.success('Factura cerrada', \{` | L53 |
| `frontend/components\layout\FacturasMenuItem.tsx` | `\{/* Main Facturas Menu Item */\}` | L76 |
| `frontend/components\layout\FacturasMenuItem.tsx` | `isActive && !isInvoiceDetailPage` | L81 |
| `frontend/components\layout\FacturasMenuItem.tsx` | `Facturas` | L87 |
| `frontend/components\layout\FacturasMenuItem.tsx` | `\{/* Sub-items (Quick Invoice Tabs) */\}` | L90 |
| `frontend/components\deliveryNotes\DeliveryNotesTable.tsx` | `const handleViewSalesOrder = (salesOrderId: number, e: React.MouseEvent) => \{` | L67 |
| `frontend/components\deliveryNotes\DeliveryNotesTable.tsx` | `<SortableTableHead>N¬∞ Pedido</SortableTableHead>` | L102 |
| `frontend/components\deliveryNotes\DeliveryNotesTable.tsx` | `onClick=\{(e) => handleViewSalesOrder(deliveryNote.salesOrderId, e)\}` | L130 |
| `frontend/components\salesOrders\SalesOrdersTable.tsx` | `import type \{ SalesOrderListDto \} from '@/types/salesOrder';` | L26 |
| `frontend/components\salesOrders\SalesOrdersTable.tsx` | `interface SalesOrdersTableProps \{` | L29 |
| `frontend/components\salesOrders\SalesOrdersTable.tsx` | `orders: SalesOrderListDto[];` | L30 |
| `frontend/components\salesOrders\SalesOrdersTable.tsx` | `export function SalesOrdersTable(\{` | L39 |
| `frontend/components\salesOrders\SalesOrdersTable.tsx` | `\}: SalesOrdersTableProps) \{` | L47 |
| `frontend/components\salesOrders\SalesOrdersTable.tsx` | `return <Badge variant="default">Facturado</Badge>;` | L56 |
| `frontend/components\salesOrders\SalesOrdersTable.tsx` | `N¬∞ Pedido` | L83 |
| `frontend/components\salesOrders\OrderSummaryStep.tsx` | `import type \{ SalesOrderFormData, SalesOrderItemFormData \} from '@/types/salesOrder';` | L7 |
| `frontend/components\salesOrders\OrderSummaryStep.tsx` | `formData: SalesOrderFormData;` | L10 |
| `frontend/components\salesOrders\OrderSummaryStep.tsx` | `const calculateLineTotal = (item: SalesOrderItemFormData) => \{` | L18 |
| `frontend/components\salesOrders\OrderSummaryStep.tsx` | `<CardTitle>Informaci√≥n del Pedido</CardTitle>` | L89 |
| `frontend/components\salesOrders\OrderSummaryStep.tsx` | `<p className="text-sm text-muted-foreground">Fecha de Pedido</p>` | L95 |
| `frontend/app\dashboard\sales-orders\page.tsx` | `import \{ SalesOrdersTable \} from '@/components/salesOrders/SalesOrdersTable';` | L12 |
| `frontend/app\dashboard\sales-orders\page.tsx` | `import \{ useSalesOrders, useCancelSalesOrder, useDeleteSalesOrder \} from '@/lib/hooks/useSalesOrders';` | L13 |
| `frontend/app\dashboard\sales-orders\page.tsx` | `export default function SalesOrdersPage() \{` | L17 |
| `frontend/app\dashboard\sales-orders\page.tsx` | `const \{ data, isLoading \} = useSalesOrders(\{` | L35 |
| `frontend/app\dashboard\sales-orders\page.tsx` | `const cancelOrderMutation = useCancelSalesOrder();` | L42 |
| `frontend/app\dashboard\sales-orders\page.tsx` | `const deleteOrderMutation = useDeleteSalesOrder();` | L43 |
| `frontend/app\dashboard\sales-orders\page.tsx` | `<h1 className="text-3xl font-bold tracking-tight">Pedidos</h1>` | L85 |
| `frontend/app\dashboard\sales-orders\page.tsx` | `Nuevo Pedido` | L90 |
| `frontend/app\dashboard\sales-orders\page.tsx` | `<CardTitle className="text-sm font-medium">Total Pedidos</CardTitle>` | L98 |
| `frontend/app\dashboard\sales-orders\page.tsx` | `<CardTitle className="text-sm font-medium">Facturados</CardTitle>` | L116 |
| `frontend/app\dashboard\sales-orders\page.tsx` | `<SelectItem value="INVOICED">Facturado</SelectItem>` | L173 |
| `frontend/app\dashboard\sales-orders\page.tsx` | `<CardTitle>Lista de Pedidos</CardTitle>` | L217 |
| `frontend/app\dashboard\sales-orders\page.tsx` | `<SalesOrdersTable` | L227 |
| `frontend/app\api\invoices\[id]\print-pdf\route.ts` | `\{ error: 'Invoice not found' \},` | L37 |
| `frontend/app\api\invoices\[id]\print-pdf\route.ts` | `const pdfBuffer = await pdfService.generateInvoicePDF(` | L50 |
| `frontend/app\api\invoices\[id]\pdf\route.ts` | `\{ error: 'Invoice not found' \},` | L37 |
| `frontend/app\api\invoices\[id]\pdf\route.ts` | `const pdfBuffer = await pdfService.generateInvoicePDF(` | L43 |
| `frontend/app\api\invoices\[id]\preview-pdf\route.ts` | `\{ error: 'Invoice not found' \},` | L37 |
| `frontend/app\api\invoices\[id]\preview-pdf\route.ts` | `const pdfBuffer = await pdfService.generateInvoicePDF(` | L43 |
| `frontend/app\api\invoices\[id]\route.ts` | `import \{ mapInvoiceToDTO \} from '@/lib/utils/mapper';` | L3 |
| `frontend/app\api\invoices\[id]\route.ts` | `import \{ updateInvoiceSchema \} from '@/lib/validations/schemas';` | L4 |
| `frontend/app\api\invoices\[id]\route.ts` | `\{ error: 'Invoice not found' \},` | L56 |
| `frontend/app\api\invoices\[id]\route.ts` | `const mappedInvoice = mapInvoiceToDTO(invoice);` | L62 |
| `frontend/app\api\invoices\[id]\route.ts` | `return NextResponse.json(mappedInvoice);` | L64 |
| `frontend/app\api\invoices\[id]\route.ts` | `const existingInvoice = await prisma.invoices.findUnique(\{` | L84 |
| `frontend/app\api\invoices\[id]\route.ts` | `if (!existingInvoice \|\| existingInvoice.deleted_at) \{` | L88 |
| `frontend/app\api\invoices\[id]\route.ts` | `\{ error: 'Invoice not found' \},` | L90 |
| `frontend/app\api\invoices\[id]\route.ts` | `if (existingInvoice.is_cancelled) \{` | L96 |
| `frontend/app\api\invoices\[id]\route.ts` | `const validatedData = updateInvoiceSchema.parse(body);` | L104 |
| `frontend/app\api\invoices\[id]\route.ts` | `const isCancellingPrintedInvoice = (body.is_cancelled === true \|\| body.isCancelled === true) &&` | L134 |
| `frontend/app\api\invoices\[id]\route.ts` | `!existingInvoice.is_cancelled &&` | L135 |
| `frontend/app\api\invoices\[id]\route.ts` | `existingInvoice.is_printed;` | L136 |
| `frontend/app\api\invoices\[id]\route.ts` | `const isPrintingNow = (body.is_printed === true \|\| body.isPrinted === true) && !existingInvoice.is_printed;` | L146 |
| `frontend/app\api\invoices\[id]\route.ts` | `if (!existingInvoice.printed_at) \{` | L149 |
| `frontend/app\api\invoices\[id]\route.ts` | `if (isCancellingPrintedInvoice) \{` | L157 |
| `frontend/app\api\invoices\[id]\route.ts` | `where: \{ id: existingInvoice.sales_order_id \},` | L160 |
| `frontend/app\api\invoices\[id]\route.ts` | `reference_document: `Cancelaci√≥n factura $\{existingInvoice.invoice_number\}`,` | L174 |
| `frontend/app\api\invoices\[id]\route.ts` | `where: \{ id: existingInvoice.sales_order_id \},` | L200 |
| `frontend/app\api\invoices\[id]\route.ts` | `reference_document: `Impresi√≥n factura $\{existingInvoice.invoice_number\}`,` | L214 |
| `frontend/app\api\invoices\[id]\route.ts` | `const updatedInvoice = await tx.invoices.update(\{` | L237 |
| `frontend/app\api\invoices\[id]\route.ts` | `where: \{ id: existingInvoice.sales_order_id \},` | L253 |
| `frontend/app\api\invoices\[id]\route.ts` | `where: \{ id: existingInvoice.sales_order_id \},` | L267 |
| `frontend/app\api\invoices\[id]\route.ts` | `return updatedInvoice;` | L276 |


</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Investigating Order Forms**

I'm currently reviewing `frontend/components/salesOrders/SingleStepOrderForm.tsx`. It seems to be the primary interface for creating sales orders. Now, I must locate the corresponding component or components associated with invoices, aiming to understand how the two are structured. I'm exploring the `frontend/app/dashboard/invoices` directory for related code.


**Seeking Invoice Components**

I've been digging deeper. I've pinpointed the sales order form, which is quite helpful. Now, I'm trying to determine where invoice creation takes place. I'm focusing on components. The `frontend/app/dashboard/invoices/[id]/page.tsx` file provides some clues, but I'm primarily focused on finding the actual form used for invoices. So, I will check the `frontend/components/invoices/` directory.


</details></think>

---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_dir** ‚Ä¢ Listed directory, 0 results</summary>
        
No results found
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Examining Component Locations**

I'm now investigating potential locations for the `InvoiceForm.tsx` file. The original directory didn't yield results, so I've pivoted and am exploring the `frontend/components/salesOrders` directory for clues. I suspect the component may be misnamed or placed in a related folder.


</details></think>

---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_dir** ‚Ä¢ Listed directory, 0 results</summary>
        
No results found
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Investigating Invoice Display**

I'm currently focused on the invoice display and edit format. The user's request specifies a similar appearance for the order form. I've started by examining the invoice interface within the system, specifically the `frontend/app/dashboard/invoices/` directory to understand its layout and presentation. I'm keen to find the relevant components.


**Inspecting Invoice Components**

I'm now diving into the invoice details page, specifically `frontend/app/dashboard/invoices/[id]/page.tsx`, to understand its structure. My plan includes checking the components directory for any relevant invoice-related elements, looking for keywords like "Invoice" to streamline the search for creation and editing functionalities, like QuickInvoice.


</details></think>

---

<tool-use data-tool-type="generic" data-tool-name="glob_file_search">
<details>
<summary>Tool use: **glob_file_search** ‚Ä¢ Searched codebase "**/Invoice*.tsx" ‚Ä¢ **1** result in **1** directory</summary>

Directory: **d:\dialfa new\spisa-new\frontend\components** (1 file)

| File |
|------|
| `invoices\InvoicesTable.tsx` |

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Exploring the Dashboard Code**

I'm now investigating the "facturas" form's structure within the dashboard. My current approach involves searching for "Invoice" within the `frontend/app/dashboard/` directory to understand how the form is implemented. I'm trying to determine whether it's a distinct component or integrated into an existing page.


</details></think>

---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_dir** ‚Ä¢ Listed directory, 0 results</summary>
        
No results found
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Investigating Invoice Pages**

I'm currently reviewing `frontend/app/dashboard/invoices/new/page.tsx` and `frontend/app/dashboard/invoices/[id]/page.tsx`. My focus is to understand how new invoices are created and how existing ones are displayed, to identify any potential areas for optimization. The goal is to see how the data flows in these components.


</details></think>

---

Could not find file 'frontend/app/dashboard/invoices/new/page.tsx' in the workspace.

---

<think><details><summary>Thought Process</summary>
**Defining Path Resolution**

I've homed in on how to resolve the file paths. I've realized I need the relative path from the workspace root. Looking at the example path structure, and the `project_layout` data, I have a clearer picture of how to navigate from the root to the frontend files. It's becoming clearer.


**Pinpointing the Target Path**

Now, I'm trying to get to the `page.tsx` file. Considering the `project_layout` and the example file paths, it's seeming more achievable. I'm going to follow the directory structure in the `project_layout` data to correctly resolve this. I am now trying to read `frontend/app/dashboard/invoices/[ id]/page.tsx`.


</details></think>

---

Could not find file 'frontend/app/dashboard/invoices/[id]/page.tsx' in the workspace.

---

<think><details><summary>Thought Process</summary>
**Identifying Context and Path**

I'm currently processing multiple workspaces; `D:\dialfa new\spisa-new` is a primary one. My immediate need is to pinpoint the exact path, and it looks like I need to resolve `frontend/ app/dashboard/invoices/[id]/page.tsx` relative to the aforementioned directory. I am paused, however.


**Determining the Relative Path**

Now, I've confirmed that the primary workspace is indeed `D:\dialfa new\spisa-new`, so the path should be `frontend/app/dashboard/invoices/[id]/page.tsx` relative to that. I'm double-checking the file structure now to make absolutely certain. It would be an error if I were to misinterpret it.


</details></think>

---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_dir** ‚Ä¢ Listed directory, 0 results</summary>
        
No results found
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Investigating Directory Discrepancies**

I'm currently puzzled by the directory listings. It appears the `list_dir` function is returning unexpected results. The root directory shows `spisa` instead of `spisa-new`, which is concerning. I'm cross-referencing this against the multiple workspace paths provided by the user, trying to identify a potential mismatch or root cause, especially concerning the different paths used.


**Re-evaluating Path Navigation**

The plot thickens! Listing `.` gave `spisa` while the user's workspace path has `spisa-new`. I'm now zeroing in on discrepancies between the `list_dir` output and the project layout, specifically the root directory identification. I am now trying `d:\dialfa new\spisa-new\frontend \app\dashboard\invoices` explicitly to gain more clarity.


</details></think>

---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_dir** ‚Ä¢ Listed directory, 0 results</summary>
        
No results found
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Analyzing the Codebase**

I'm currently reviewing the `page.tsx` file within the invoices directory, focusing on how it handles invoice IDs. I'm taking notes on its structure and approach.


</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** ‚Ä¢ Read file: d:\dialfa new\spisa-new\frontend\app\dashboard\invoices\[id]\page.tsx</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Considering Component Usage**

I'm currently focused on the structure of the invoice detail page. I've noted the use of `Card` components to organize different sections like customer and invoice information, items, and totals. The item details are presented in a `Table`. Next, I'll examine the `SingleStepOrderForm.tsx` file to get a clearer picture of how it all ties together.


**Inspecting Form Integration**

I'm now investigating the `SingleStepOrderForm.tsx` file to see how it integrates with the invoice details. I'm especially interested in how the item data, formatted within a `Table` on the invoice detail page, is populated and managed in the order form. I'm expecting some interactions with the `Card` components, too.


</details></think>

---

Could not find file 'frontend/components/salesOrders/SingleStepOrderForm.tsx' in the workspace.

---

<think><details><summary>Thought Process</summary>
**Revising Pathing Strategy**

I'm now prioritizing the absolute path or a rigorously checked relative path to avoid any ambiguity. I want to ensure the system can consistently locate the necessary files. This change should resolve the pathing issues.


</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** ‚Ä¢ Read file: d:\dialfa new\spisa-new\frontend\components\salesOrders\SingleStepOrderForm.tsx</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Re-evaluating the Layout**

I'm now contemplating a shift back to a table-based layout for the `SingleStepOrderForm`, mimicking the invoice's structure. This would mean abandoning the current `div`-based approach. The visual consistency with the invoice form is crucial, so I'm investigating the effort involved in this significant structural change.


**Comparing Structures and Designs**

I'm deep in comparing the layouts. The existing order form's `div`-based approach contrasts sharply with the invoice's table-driven design, and I'm identifying the core structural differences. The two-column grid for client info on the invoice is a key consideration. I'm taking notes on how items are displayed and how totals and headers are handled. My next step will be to explore the parent page for the order form.


</details></think>

---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_dir** ‚Ä¢ Listed directory, 0 results</summary>
        
No results found
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Investigating the Sales Orders Page**

I'm currently focused on the `frontend/app/dashboard/sales-orders/[id]/ page.tsx` file. My goal is to thoroughly understand its functionality and implementation details. I'm taking a close look at the code, analyzing its components and how it handles sales order information.


</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** ‚Ä¢ Read file: d:\dialfa new\spisa-new\frontend\app\dashboard\sales-orders\[id]\page.tsx</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Analyzing the Redirection**

I'm currently focused on the redirection logic. My attention is now on `edit/page.tsx`, following the trail to understand how the navigation is handled. I need to figure out why it's going there.


</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** ‚Ä¢ Read file: d:\dialfa new\spisa-new\frontend\app\dashboard\sales-orders\[id]\edit\page.tsx</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Analyzing Implementation Steps**

\n\n

I've begun outlining the specific code alterations needed. First, the `SingleStepOrderForm`'s header needs modification. I plan to either incorporate elements from the `EditSalesOrderPage` header or create a new header within `SingleStepOrderForm` to ensure visual consistency with the invoice detail page.


**Mapping UI Transformations**

\n\n

My focus is now on the specific UI adjustments. I've broken down the necessary changes to `SingleStepOrderForm.tsx`. First, I'll structure the layout with `Card` components, as you suggested, for the client and order information. Then, I'll swap the custom grid for a `Table` to display the items and add the "Totales" section in a `Card` of its own.


**Examining Page Comparisons**

\n\n

My current thinking is focused on understanding the user's intent. While I'm familiar with the `SingleStepOrderForm.tsx`, I am now verifying whether the request concerns the detail view or the creation form by examining the `Invoice DetailPage`. I'll also briefly check `frontend/app/dashboard/invoices/new/page.tsx`, to make sure I consider all potential user requirements, since the user is asking for similarities in appearance.


</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** ‚Ä¢ Read file: d:\dialfa new\spisa-new\frontend\app\dashboard\invoices\new\page.tsx</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Assessing the Interface**

I've zeroed in on the `InvoiceDetailPage` as the key area for aesthetic alignment. My current aim is to translate the user's desire for the order form to mirror this detail page's visual style. The challenge is ensuring the desired look and feel are faithfully reflected in the order form design.


**Evaluating the Components**

I'm now zeroing in on the `SingleStepOrderForm.tsx` file for modification. My analysis indicates the necessity of a `Table` component for item presentation, and a `Card` for the totals. I've also identified a grid layout for client and order information as a key improvement to match the `InvoiceDetailPage`'s visual language.


**Revising Implementation Strategy**

I've refocused on the specifics of `SingleStepOrderForm.tsx`. My recent work includes adding essential `@/components/ui/table` imports. I've now formulated a concrete plan: implement a grid layout for client and order information, swap the existing item presentation with a `Table` component, and integrate a `Card` to encapsulate the totals section.


</details></think>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** ‚Ä¢ Todo List</summary>

- [-] Refactor SingleStepOrderForm layout to match Invoice Detail style
- [ ] Implement Table-based items list in Order Form
- [ ] Add Totals card to Order Form
- [ ] Verify consistency with Invoice Detail view

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Refactoring the layout**

I'm currently focused on refactoring the layout of `SingleStepOrderForm.tsx`. I've started by importing the necessary `Table` components and will proceed with restructuring the existing elements to improve readability and maintainability.


</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** ‚Ä¢ Edit file: d:\dialfa new\spisa-new\frontend\components\salesOrders\SingleStepOrderForm.tsx</summary>

**Chunk 1**
Lines added: 10, lines removed: 1

```diff
@@ -3,6 +3,15 @@
  import { useState, useEffect, useRef } from 'react';
  import { Button } from '@/components/ui/button';
- import { Card, CardContent } from '@/components/ui/card';
+ import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
  import { Input } from '@/components/ui/input';
+ import { Label } from '@/components/ui/label';
+ import {
+   Table,
+   TableBody,
+   TableCell,
+   TableHead,
+   TableHeader,
+   TableRow,
+ } from '@/components/ui/table';
  import { ClientLookup } from '@/components/articles/ClientLookup';
  import { useCreateSalesOrder, useGenerateInvoice, useGenerateDeliveryNote } from '@/lib/hooks/useSalesOrders';
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
**Refactoring the UI**

I'm currently focused on refactoring the UI. I plan to start with the Client Section, incorporating an Order Info section alongside it. The next step is to replace the items list with a `Table` component for improved clarity. This is all being done in incremental steps to avoid any large-scale regressions.


</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** ‚Ä¢ Edit file: d:\dialfa new\spisa-new\frontend\components\salesOrders\SingleStepOrderForm.tsx</summary>

**Chunk 1**
Lines added: 73, lines removed: 20

```diff
@@ -779,29 +779,82 @@
  
        {/* Client and General Info Section */}
-       &lt;Card&gt;
-         &lt;CardContent className="pt-4"&gt;
-           &lt;div&gt;
+       &lt;div className="grid gap-6 md:grid-cols-2"&gt;
+         &lt;Card&gt;
+           &lt;CardHeader&gt;
+             &lt;CardTitle&gt;Informaci√≥n del Cliente&lt;/CardTitle&gt;
+           &lt;/CardHeader&gt;
+           &lt;CardContent&gt;
              {clientId &amp;&amp; clientName ? (
-               &lt;div className="flex items-center gap-2"&gt;
-                 &lt;div className="flex-1 flex items-center gap-2 p-2 bg-primary/10 border border-primary/20 rounded"&gt;
-                   &lt;User className="h-4 w-4 text-primary" /&gt;
-                   &lt;div className="flex-1 min-w-0"&gt;
-                     &lt;div className="text-sm font-medium truncate"&gt;{clientName}&lt;/div&gt;
-                   &lt;/div&gt;
-                 &lt;/div&gt;
-                 &lt;Button
-                   variant="ghost"
-                   size="icon"
-                   onClick={handleClearClient}
-                 &gt;
-                   &lt;X className="h-4 w-4" /&gt;
-                 &lt;/Button&gt;
+               &lt;div className="space-y-4"&gt;
+                 &lt;div className="flex items-center justify-between p-3 bg-primary/10 border border-primary/20 rounded-lg"&gt;
+                   &lt;div className="flex items-center gap-3"&gt;
+                     &lt;User className="h-5 w-5 text-primary" /&gt;
+                     &lt;div&gt;
+                       &lt;p className="text-sm font-medium"&gt;{clientName}&lt;/p&gt;
+                       {existingOrder &amp;&amp; (
+                         &lt;p className="text-xs text-muted-foreground"&gt;CUIT: {existingOrder.clientCuit}&lt;/p&gt;
+                       )}
+                     &lt;/div&gt;
+                   &lt;/div&gt;
+                   {!isReadOnly &amp;&amp; (
+                     &lt;Button
+                       variant="ghost"
+                       size="icon"
+                       onClick={handleClearClient}
+                       className="h-8 w-8"
+                     &gt;
+                       &lt;X className="h-4 w-4" /&gt;
+                     &lt;/Button&gt;
+                   )}
+                 &lt;/div&gt;
                &lt;/div&gt;
              ) : (
                &lt;ClientLookup onSelectClient={handleSelectClient} /&gt;
              )}
-           &lt;/div&gt;
-         &lt;/CardContent&gt;
-       &lt;/Card&gt;
+           &lt;/CardContent&gt;
+         &lt;/Card&gt;
+ 
+         &lt;Card&gt;
+           &lt;CardHeader&gt;
+             &lt;CardTitle&gt;Informaci√≥n del Pedido&lt;/CardTitle&gt;
+           &lt;/CardHeader&gt;
+           &lt;CardContent className="space-y-4"&gt;
+             &lt;div className="grid grid-cols-2 gap-4"&gt;
+               &lt;div className="space-y-1"&gt;
+                 &lt;p className="text-sm text-muted-foreground"&gt;N√∫mero de Pedido&lt;/p&gt;
+                 &lt;p className="font-medium"&gt;{existingOrder?.orderNumber || 'Borrador'}&lt;/p&gt;
+               &lt;/div&gt;
+               &lt;div className="space-y-1"&gt;
+                 &lt;p className="text-sm text-muted-foreground"&gt;Estado&lt;/p&gt;
+                 &lt;div&gt;
+                   {existingOrder ? (
+                     existingOrder.invoice &amp;&amp; !existingOrder.invoice.isCancelled ? (
+                       &lt;Badge className={existingOrder.invoice.isPrinted ? "bg-green-600" : "bg-blue-600"}&gt;
+                         {existingOrder.invoice.isPrinted ? "Facturado e Impreso" : "Facturado"}
+                       &lt;/Badge&gt;
+                     ) : (
+                       &lt;Badge variant="secondary"&gt;Pendiente&lt;/Badge&gt;
+                     )
+                   ) : (
+                     &lt;Badge variant="outline"&gt;Nuevo&lt;/Badge&gt;
+                   )}
+                 &lt;/div&gt;
+               &lt;/div&gt;
+             &lt;/div&gt;
+ 
+             &lt;div className="space-y-2"&gt;
+               &lt;Label htmlFor="orderNotes"&gt;Observaciones&lt;/Label&gt;
+               &lt;textarea
+                 id="orderNotes"
+                 className="w-full min-h-[80px] p-2 text-sm bg-background border rounded-md resize-none focus:outline-none focus:ring-1 focus:ring-primary"
+                 placeholder="Notas adicionales para el pedido..."
+                 value={notes}
+                 onChange={(e) =&gt; setNotes(e.target.value)}
+                 disabled={isReadOnly}
+               /&gt;
+             &lt;/div&gt;
+           &lt;/CardContent&gt;
+         &lt;/Card&gt;
+       &lt;/div&gt;
  
        {/* Articles Section */}
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
**Evaluating Restructuring Options**

I'm currently focused on refactoring the presentation of search results. My goal is to replace the item list with a table for better organization. I've also decided to reposition the search bar above the table, streamlining the user experience. A key concern now is how the search dropdown will interact within the table layout, so I'll need to test that in the invoice detail page.


**Assessing UI Component Interactions**

I'm now diving deeper into how the search dropdown will perform within the new table structure, especially in the order form where items can be added. I've located the "Items" card within `SingleStepOrderForm.tsx` and am now refactoring its "Articles Section" `Card`, considering its design consistency with the invoice detail page.


</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** ‚Ä¢ Edit file: d:\dialfa new\spisa-new\frontend\components\salesOrders\SingleStepOrderForm.tsx</summary>

**Chunk 1**
Lines added: 117, lines removed: 122

```diff
@@ -859,126 +859,121 @@
  
        {/* Articles Section */}
-       &lt;Card className="flex-1"&gt;
-         &lt;CardContent className="pt-4"&gt;
-           &lt;div className="space-y-3"&gt;
- 
-             {/* Quick Article Lookup */}
-             {!isReadOnly &amp;&amp; (
-               &lt;div className="p-3 border rounded-lg bg-muted/30"&gt;
-                 &lt;div className="flex items-start gap-2"&gt;
-                   &lt;div className="flex-1 relative"&gt;
-                     &lt;div className="relative"&gt;
-                       &lt;Search className="absolute left-2 top-1/2 -translate-y-1/2 h-3.5 w-3.5 text-muted-foreground" /&gt;
-                       &lt;Input
-                         ref={codeInputRef}
-                         value={articleCode}
-                         onChange={(e) =&gt; {
-                           setArticleCode(e.target.value.toUpperCase());
-                           setShowCodeResults(true);
-                           setSelectedArticle(null);
-                         }}
-                         onKeyDown={handleCodeKeyDown}
-                         onFocus={() =&gt; articleCode &amp;&amp; setShowCodeResults(true)}
-                         onBlur={() =&gt; setTimeout(() =&gt; setShowCodeResults(false), 200)}
-                         placeholder="Buscar art√≠culo..."
-                         className="pl-7 uppercase text-sm h-9"
-                       /&gt;
-                     &lt;/div&gt;
- 
-                     {/* Search Results Dropdown */}
-                     {showCodeResults &amp;&amp; articleCode &amp;&amp; articles.length &gt; 0 &amp;&amp; (
-                       &lt;Card className="absolute z-[60] w-full mt-1 max-h-[280px] overflow-auto shadow-xl"&gt;
-                         &lt;div className="p-1"&gt;
-                           {articles.map((article, index) =&gt; (
-                             &lt;button
-                               key={article.id}
-                               ref={index === selectedIndex ? selectedItemRef : null}
-                               onClick={() =&gt; handleSelectArticle(article, index)}
-                               className={&#96;w-full text-left p-2.5 rounded transition-colors ${index === selectedIndex ? 'bg-primary text-primary-foreground' : 'hover:bg-accent hover:text-accent-foreground'
-                                 }&#96;}
-                             &gt;
-                               &lt;div className="flex justify-between items-start gap-3"&gt;
-                                 &lt;div className="flex-1 min-w-0"&gt;
-                                   &lt;div className="font-semibold text-sm font-mono"&gt;
-                                     {article.code}
-                                   &lt;/div&gt;
-                                   &lt;div className={&#96;text-xs truncate mt-0.5 ${index === selectedIndex ? 'text-primary-foreground/90' : 'text-muted-foreground'}&#96;}&gt;
-                                     {article.description}
-                                   &lt;/div&gt;
-                                 &lt;/div&gt;
-                                 &lt;div className="text-right flex-shrink-0"&gt;
-                                   &lt;div className="text-sm font-bold"&gt;
-                                     {formatCurrency(article.unitPrice)}
-                                   &lt;/div&gt;
-                                   &lt;div className={&#96;text-xs font-medium mt-0.5 ${index === selectedIndex
-                                       ? 'text-primary-foreground'
-                                       : getStockStatusClass(article.stock)
-                                     }&#96;}&gt;
-                                     Stock: {article.stock}
-                                   &lt;/div&gt;
-                                 &lt;/div&gt;
-                               &lt;/div&gt;
-                             &lt;/button&gt;
-                           ))}
-                         &lt;/div&gt;
-                         &lt;div className="px-3 py-2 bg-muted/50 text-xs text-muted-foreground border-t"&gt;
-                           ‚Üë‚Üì Navegar | Enter/Tab Seleccionar
-                         &lt;/div&gt;
-                       &lt;/Card&gt;
-                     )}
-                   &lt;/div&gt;
- 
-                   &lt;div className="w-20"&gt;
-                     &lt;Input
-                       ref={quantityInputRef}
-                       type="number"
-                       min="1"
-                       value={quantity}
-                       onChange={(e) =&gt; setQuantity(e.target.value)}
-                       onKeyDown={handleQuantityKeyDown}
-                       onFocus={(e) =&gt; e.target.select()}
-                       placeholder="Cant."
-                       className="text-center text-sm h-9"
-                     /&gt;
-                   &lt;/div&gt;
- 
-                   &lt;div className="pt-0"&gt;
-                     &lt;Button
-                       size="sm"
-                       onClick={handleAddArticle}
-                       disabled={!selectedArticle &amp;&amp; !articleCode}
-                       className="h-9"
-                     &gt;
-                       &lt;Plus className="h-4 w-4" /&gt;
-                     &lt;/Button&gt;
-                   &lt;/div&gt;
-                 &lt;/div&gt;
-               &lt;/div&gt;
-             )}
- 
-             {/* Items List */}
-             &lt;div className="space-y-2 max-h-[600px] overflow-y-auto"&gt;
-               {items.length === 0 ? (
-                 &lt;div className="border border-dashed rounded-lg p-6 text-center text-muted-foreground"&gt;
-                   &lt;ShoppingCart className="h-8 w-8 mx-auto mb-2 opacity-30" /&gt;
-                   &lt;p className="text-sm"&gt;No hay art√≠culos agregados&lt;/p&gt;
-                   &lt;p className="text-xs mt-1"&gt;Usa el buscador para agregar&lt;/p&gt;
-                 &lt;/div&gt;
-               ) : (
-                 items.map((item) =&gt; {
-                   const hasStockIssue = item.quantity &gt; item.article.stock;
-                   return (
-                     &lt;div
-                       key={item.article.id}
-                       className={&#96;border rounded-lg p-2.5 transition-colors ${hasStockIssue
-                           ? 'border-red-300 dark:border-red-800 bg-red-50 dark:bg-red-950/30 hover:bg-red-100 dark:hover:bg-red-950/50'
-                           : 'bg-card hover:bg-accent/5'
-                         }&#96;}
-                     &gt;
-                       &lt;div className="flex items-start justify-between gap-2"&gt;
-                         &lt;div className="flex-1 min-w-0"&gt;
-                           {editingItemId === item.article.id ? (
-                             &lt;div className="relative"&gt;
-                               &lt;div className="flex items-center gap-2 mb-2"&gt;
+       &lt;Card&gt;
+         &lt;CardHeader className="flex flex-row items-center justify-between space-y-0"&gt;
+           &lt;div&gt;
+             &lt;CardTitle&gt;Items&lt;/CardTitle&gt;
+             &lt;CardDescription&gt;{items.length} art√≠culo(s)&lt;/CardDescription&gt;
+           &lt;/div&gt;
+           {!isReadOnly &amp;&amp; (
+             &lt;div className="flex items-center gap-2 max-w-md flex-1 ml-4"&gt;
+               &lt;div className="relative flex-1"&gt;
+                 &lt;Search className="absolute left-2.5 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" /&gt;
+                 &lt;Input
+                   ref={codeInputRef}
+                   value={articleCode}
+                   onChange={(e) =&gt; {
+                     setArticleCode(e.target.value.toUpperCase());
+                     setShowCodeResults(true);
+                     setSelectedArticle(null);
+                   }}
+                   onKeyDown={handleCodeKeyDown}
+                   onFocus={() =&gt; articleCode &amp;&amp; setShowCodeResults(true)}
+                   onBlur={() =&gt; setTimeout(() =&gt; setShowCodeResults(false), 200)}
+                   placeholder="Buscar c√≥digo o descripci√≥n..."
+                   className="pl-9 uppercase h-9"
+                 /&gt;
+                 
+                 {/* Search Results Dropdown */}
+                 {showCodeResults &amp;&amp; articleCode &amp;&amp; articles.length &gt; 0 &amp;&amp; (
+                   &lt;Card className="absolute z-[60] w-full mt-1 max-h-[300px] overflow-auto shadow-xl"&gt;
+                     &lt;div className="p-1"&gt;
+                       {articles.map((article, index) =&gt; (
+                         &lt;button
+                           key={article.id}
+                           ref={index === selectedIndex ? selectedItemRef : null}
+                           onClick={() =&gt; handleSelectArticle(article, index)}
+                           className={&#96;w-full text-left p-2 rounded transition-colors ${
+                             index === selectedIndex 
+                               ? 'bg-primary text-primary-foreground' 
+                               : 'hover:bg-accent hover:text-accent-foreground'
+                           }&#96;}
+                         &gt;
+                           &lt;div className="flex justify-between items-start gap-3"&gt;
+                             &lt;div className="flex-1 min-w-0"&gt;
+                               &lt;div className="font-semibold text-sm font-mono"&gt;{article.code}&lt;/div&gt;
+                               &lt;div className={&#96;text-xs truncate ${index === selectedIndex ? 'text-primary-foreground/90' : 'text-muted-foreground'}&#96;}&gt;
+                                 {article.description}
+                               &lt;/div&gt;
+                             &lt;/div&gt;
+                             &lt;div className="text-right"&gt;
+                               &lt;div className="text-sm font-bold"&gt;{formatCurrency(article.unitPrice)}&lt;/div&gt;
+                               &lt;div className={&#96;text-xs ${index === selectedIndex ? 'text-primary-foreground' : getStockStatusClass(article.stock)}&#96;}&gt;
+                                 Stock: {article.stock}
+                               &lt;/div&gt;
+                             &lt;/div&gt;
+                           &lt;/div&gt;
+                         &lt;/button&gt;
+                       ))}
+                     &lt;/div&gt;
+                   &lt;/Card&gt;
+                 )}
+               &lt;/div&gt;
+               &lt;div className="w-20"&gt;
+                 &lt;Input
+                   ref={quantityInputRef}
+                   type="number"
+                   min="1"
+                   value={quantity}
+                   onChange={(e) =&gt; setQuantity(e.target.value)}
+                   onKeyDown={handleQuantityKeyDown}
+                   onFocus={(e) =&gt; e.target.select()}
+                   placeholder="Cant."
+                   className="text-center h-9"
+                 /&gt;
+               &lt;/div&gt;
+               &lt;Button
+                 size="sm"
+                 onClick={handleAddArticle}
+                 disabled={!selectedArticle &amp;&amp; !articleCode}
+                 className="h-9"
+               &gt;
+                 &lt;Plus className="h-4 w-4" /&gt;
+               &lt;/Button&gt;
+             &lt;/div&gt;
+           )}
+         &lt;/CardHeader&gt;
+         &lt;CardContent&gt;
+           {items.length === 0 ? (
+             &lt;div className="border border-dashed rounded-lg p-12 text-center text-muted-foreground"&gt;
+               &lt;ShoppingCart className="h-12 w-12 mx-auto mb-4 opacity-20" /&gt;
+               &lt;p&gt;No hay art√≠culos en este pedido&lt;/p&gt;
+               {!isReadOnly &amp;&amp; &lt;p className="text-sm mt-1"&gt;Usa el buscador para agregar art√≠culos&lt;/p&gt;}
+             &lt;/div&gt;
+           ) : (
+             &lt;div className="border rounded-md"&gt;
+               &lt;Table&gt;
+                 &lt;TableHeader&gt;
+                   &lt;TableRow&gt;
+                     &lt;TableHead className="w-[150px]"&gt;C√≥digo&lt;/TableHead&gt;
+                     &lt;TableHead&gt;Descripci√≥n&lt;/TableHead&gt;
+                     &lt;TableHead className="text-right w-[100px]"&gt;Cantidad&lt;/TableHead&gt;
+                     &lt;TableHead className="text-right w-[140px]"&gt;Precio Unit.&lt;/TableHead&gt;
+                     &lt;TableHead className="text-right w-[100px]"&gt;Descuento&lt;/TableHead&gt;
+                     &lt;TableHead className="text-right w-[140px]"&gt;Total&lt;/TableHead&gt;
+                     {!isReadOnly &amp;&amp; &lt;TableHead className="w-[50px]"&gt;&lt;/TableHead&gt;}
+                   &lt;/TableRow&gt;
+                 &lt;/TableHeader&gt;
+                 &lt;TableBody&gt;
+                   {items.map((item) =&gt; {
+                     const hasStockIssue = item.quantity &gt; item.article.stock;
+                     return (
+                       &lt;TableRow 
+                         key={item.article.id}
+                         className={hasStockIssue ? "bg-red-50 dark:bg-red-950/20" : ""}
+                       &gt;
+                         &lt;TableCell&gt;
+                           &lt;div className="space-y-1"&gt;
+                             {editingItemId === item.article.id ? (
+                               &lt;div className="relative"&gt;
                                  &lt;Input
                                    ref={editInputRef}
```

**Chunk 2**
Lines added: 132, lines removed: 153

```diff
@@ -989,163 +984,142 @@
                                    }}
                                    onKeyDown={handleEditKeyDown}
-                                   onFocus={() =&gt; editCode &amp;&amp; setShowEditResults(true)}
-                                   onBlur={() =&gt; setTimeout(() =&gt; setShowEditResults(false), 200)}
-                                   className="h-7 text-sm font-mono uppercase"
-                                   placeholder="Buscar c√≥digo..."
+                                   className="h-8 text-xs font-mono uppercase"
                                    autoFocus
                                  /&gt;
-                                 &lt;Button
-                                   variant="ghost"
-                                   size="icon"
-                                   className="h-7 w-7"
-                                   onClick={handleCancelEdit}
-                                 &gt;
-                                   &lt;X className="h-3.5 w-3.5" /&gt;
-                                 &lt;/Button&gt;
-                               &lt;/div&gt;
- 
-                               {/* Edit Search Results */}
-                               {showEditResults &amp;&amp; editCode &amp;&amp; editArticles.length &gt; 0 &amp;&amp; (
-                                 &lt;Card className="absolute z-[70] w-full mt-1 max-h-[200px] overflow-auto shadow-xl"&gt;
-                                   &lt;div className="p-1"&gt;
-                                     {editArticles.map((article, index) =&gt; (
-                                       &lt;button
-                                         key={article.id}
-                                         ref={index === selectedEditIndex ? selectedEditItemRef : null}
-                                         onClick={() =&gt; handleSelectEditArticle(article)}
-                                         className={&#96;w-full text-left p-2 rounded transition-colors ${index === selectedEditIndex ? 'bg-primary text-primary-foreground' : 'hover:bg-accent hover:text-accent-foreground'
+                                 {showEditResults &amp;&amp; editCode &amp;&amp; editArticles.length &gt; 0 &amp;&amp; (
+                                   &lt;Card className="absolute z-[70] w-[300px] mt-1 shadow-xl"&gt;
+                                     &lt;div className="p-1"&gt;
+                                       {editArticles.map((article, index) =&gt; (
+                                         &lt;button
+                                           key={article.id}
+                                           onClick={() =&gt; handleSelectEditArticle(article)}
+                                           className={&#96;w-full text-left p-2 rounded text-xs ${
+                                             index === selectedEditIndex ? 'bg-primary text-primary-foreground' : 'hover:bg-accent'
                                            }&#96;}
-                                       &gt;
-                                         &lt;div className="flex justify-between items-start gap-2"&gt;
-                                           &lt;div className="flex-1 min-w-0"&gt;
-                                             &lt;div className="font-semibold text-xs font-mono"&gt;
-                                               {article.code}
-                                             &lt;/div&gt;
-                                             &lt;div className={&#96;text-xs truncate ${index === selectedEditIndex ? 'text-primary-foreground/90' : 'text-muted-foreground'}&#96;}&gt;
-                                               {article.description}
-                                             &lt;/div&gt;
-                                           &lt;/div&gt;
-                                           &lt;div className="text-xs"&gt;
-                                             {formatCurrency(article.unitPrice)}
-                                           &lt;/div&gt;
-                                         &lt;/div&gt;
-                                       &lt;/button&gt;
-                                     ))}
-                                   &lt;/div&gt;
-                                   &lt;div className="px-2 py-1 bg-muted/50 text-xs text-muted-foreground border-t"&gt;
-                                     ‚Üë‚Üì Enter Esc
-                                   &lt;/div&gt;
-                                 &lt;/Card&gt;
-                               )}
-                             &lt;/div&gt;
-                           ) : (
-                             &lt;div className="grid grid-cols-[2fr_3fr_1fr_1fr_1.5fr_auto] gap-2 items-center"&gt;
-                               {/* Column 1: Code with Stock */}
-                               &lt;div className="flex flex-col gap-0.5"&gt;
-                                 &lt;div className="flex items-center gap-1.5"&gt;
-                                   &lt;div className="font-medium text-sm font-mono"&gt;
-                                     {item.article.code}
-                                   &lt;/div&gt;
-                                   {!isReadOnly &amp;&amp; (
-                                     &lt;Button
-                                       variant="ghost"
-                                       size="icon"
-                                       className="h-4 w-4 p-0"
-                                       onClick={() =&gt; handleEditItem(item.article.id, item.article.code)}
-                                     &gt;
-                                       &lt;Pencil className="h-3 w-3 text-muted-foreground hover:text-foreground" /&gt;
-                                     &lt;/Button&gt;
-                                   )}
-                                 &lt;/div&gt;
-                                 &lt;div className="text-xs text-muted-foreground flex items-center gap-1"&gt;
-                                   &lt;span&gt;(Stock: &lt;span className={getStockStatusClass(item.article.stock)}&gt;{item.article.stock}&lt;/span&gt;)&lt;/span&gt;
-                                   {item.quantity &gt; item.article.stock &amp;&amp; (
-                                     &lt;div title={&#96;Stock insuficiente: solicitado ${item.quantity}, disponible ${item.article.stock}&#96;}&gt;
-                                       &lt;AlertTriangle
-                                         className="h-3 w-3 text-red-600 flex-shrink-0"
-                                       /&gt;
-                                     &lt;/div&gt;
-                                   )}
-                                 &lt;/div&gt;
-                               &lt;/div&gt;
- 
-                               {/* Column 2: Description */}
-                               &lt;div className="text-xs text-muted-foreground truncate"&gt;
-                                 {item.article.description}
-                               &lt;/div&gt;
- 
-                               {/* Column 3: Quantity */}
-                               &lt;div&gt;
-                                 &lt;Input
-                                   type="number"
-                                   min="1"
-                                   value={item.quantity}
-                                   onChange={(e) =&gt; handleUpdateQuantity(item.article.id, parseInt(e.target.value) || 1)}
-                                   className="h-8 text-sm text-center"
-                                   onFocus={(e) =&gt; e.target.select()}
-                                   disabled={isReadOnly}
-                                 /&gt;
-                               &lt;/div&gt;
- 
-                               {/* Column 4: Discount % */}
-                               &lt;div&gt;
-                                 &lt;Input
-                                   type="number"
-                                   min="0"
-                                   max="100"
-                                   step="0.01"
-                                   value={item.discountPercent || 0}
-                                   onChange={(e) =&gt; handleUpdateDiscount(item.article.id, parseFloat(e.target.value) || 0)}
-                                   className="h-8 text-sm text-right"
-                                   onFocus={(e) =&gt; e.target.select()}
-                                   disabled={isReadOnly}
-                                 /&gt;
-                               &lt;/div&gt;
- 
-                               {/* Column 5: Price */}
-                               &lt;div&gt;
-                                 &lt;Input
-                                   type="number"
-                                   min="0"
-                                   step="0.01"
-                                   value={prices[item.article.id] ?? item.article.unitPrice}
-                                   onChange={(e) =&gt; handleUpdateUnitPrice(item.article.id, parseFloat(e.target.value) || 0)}
-                                   className="h-8 text-sm text-right"
-                                   onFocus={(e) =&gt; e.target.select()}
-                                   disabled={isReadOnly}
-                                 /&gt;
-                               &lt;/div&gt;
- 
-                               {/* Delete Button */}
-                               {!isReadOnly &amp;&amp; (
-                                 &lt;Button
-                                   variant="ghost"
-                                   size="icon"
-                                   className="h-8 w-8"
-                                   onClick={() =&gt; handleRemoveItem(item.article.id)}
-                                 &gt;
-                                   &lt;Trash2 className="h-4 w-4 text-red-600" /&gt;
-                                 &lt;/Button&gt;
-                               )}
-                             &lt;/div&gt;
-                           )}
-                         &lt;/div&gt;
-                       &lt;/div&gt;
-                     &lt;/div&gt;
-                   );
-                 })
-               )}
+                                         &gt;
+                                           &lt;div className="font-mono font-bold"&gt;{article.code}&lt;/div&gt;
+                                           &lt;div className="truncate opacity-80"&gt;{article.description}&lt;/div&gt;
+                                         &lt;/button&gt;
+                                       ))}
+                                     &lt;/div&gt;
+                                   &lt;/Card&gt;
+                                 )}
+                               &lt;/div&gt;
+                             ) : (
+                               &lt;div className="flex items-center gap-1.5"&gt;
+                                 &lt;span className="font-mono font-medium"&gt;{item.article.code}&lt;/span&gt;
+                                 {!isReadOnly &amp;&amp; (
+                                   &lt;Button
+                                     variant="ghost"
+                                     size="icon"
+                                     className="h-5 w-5 opacity-0 group-hover:opacity-100 transition-opacity"
+                                     onClick={() =&gt; handleEditItem(item.article.id, item.article.code)}
+                                   &gt;
+                                     &lt;Pencil className="h-3 w-3" /&gt;
+                                   &lt;/Button&gt;
+                                 )}
+                               &lt;/div&gt;
+                             )}
+                             &lt;div className="text-[10px] text-muted-foreground flex items-center gap-1"&gt;
+                               &lt;span&gt;Stock: &lt;span className={getStockStatusClass(item.article.stock)}&gt;{item.article.stock}&lt;/span&gt;&lt;/span&gt;
+                               {hasStockIssue &amp;&amp; &lt;AlertTriangle className="h-3 w-3 text-red-600" /&gt;}
+                             &lt;/div&gt;
+                           &lt;/div&gt;
+                         &lt;/TableCell&gt;
+                         &lt;TableCell&gt;
+                           &lt;p className="text-sm line-clamp-1" title={item.article.description}&gt;
+                             {item.article.description}
+                           &lt;/p&gt;
+                         &lt;/TableCell&gt;
+                         &lt;TableCell className="text-right"&gt;
+                           &lt;Input
+                             type="number"
+                             min="1"
+                             value={item.quantity}
+                             onChange={(e) =&gt; handleUpdateQuantity(item.article.id, parseInt(e.target.value) || 1)}
+                             className="h-8 w-20 ml-auto text-right text-sm"
+                             disabled={isReadOnly}
+                           /&gt;
+                         &lt;/TableCell&gt;
+                         &lt;TableCell className="text-right"&gt;
+                           &lt;Input
+                             type="number"
+                             min="0"
+                             step="0.01"
+                             value={prices[item.article.id] ?? item.article.unitPrice}
+                             onChange={(e) =&gt; handleUpdateUnitPrice(item.article.id, parseFloat(e.target.value) || 0)}
+                             className="h-8 w-28 ml-auto text-right text-sm font-medium"
+                             disabled={isReadOnly}
+                           /&gt;
+                         &lt;/TableCell&gt;
+                         &lt;TableCell className="text-right"&gt;
+                           &lt;div className="flex items-center justify-end gap-1"&gt;
+                             &lt;Input
+                               type="number"
+                               min="0"
+                               max="100"
+                               step="0.01"
+                               value={item.discountPercent || 0}
+                               onChange={(e) =&gt; handleUpdateDiscount(item.article.id, parseFloat(e.target.value) || 0)}
+                               className="h-8 w-16 text-right text-sm"
+                               disabled={isReadOnly}
+                             /&gt;
+                             &lt;span className="text-xs text-muted-foreground"&gt;%&lt;/span&gt;
+                           &lt;/div&gt;
+                         &lt;/TableCell&gt;
+                         &lt;TableCell className="text-right font-bold"&gt;
+                           {formatCurrency(calculateLineTotal(item))}
+                         &lt;/TableCell&gt;
+                         {!isReadOnly &amp;&amp; (
+                           &lt;TableCell&gt;
+                             &lt;Button
+                               variant="ghost"
+                               size="icon"
+                               className="h-8 w-8 text-destructive hover:text-destructive hover:bg-destructive/10"
+                               onClick={() =&gt; handleRemoveItem(item.article.id)}
+                             &gt;
+                               &lt;Trash2 className="h-4 w-4" /&gt;
+                             &lt;/Button&gt;
+                           &lt;/TableCell&gt;
+                         )}
+                       &lt;/TableRow&gt;
+                     );
+                   })}
+                 &lt;/TableBody&gt;
+               &lt;/Table&gt;
              &lt;/div&gt;
+           )}
+         &lt;/CardContent&gt;
+       &lt;/Card&gt;
  
-             {/* Total */}
-             {items.length &gt; 0 &amp;&amp; (
-               &lt;div className="flex justify-between items-center p-2.5 bg-muted/50 rounded-lg"&gt;
-                 &lt;span className="text-sm font-medium"&gt;Total&lt;/span&gt;
-                 &lt;span className="text-2xl font-bold"&gt;{formatCurrency(calculateTotal())}&lt;/span&gt;
+       {/* Totals Section */}
+       {items.length &gt; 0 &amp;&amp; (
+         &lt;div className="flex justify-end"&gt;
+           &lt;Card className="w-full md:w-[400px]"&gt;
+             &lt;CardHeader className="py-4"&gt;
+               &lt;CardTitle className="text-lg"&gt;Resumen del Pedido&lt;/CardTitle&gt;
+             &lt;/CardHeader&gt;
+             &lt;CardContent className="space-y-2 pb-6"&gt;
+               &lt;div className="flex justify-between text-sm"&gt;
+                 &lt;span className="text-muted-foreground"&gt;Subtotal&lt;/span&gt;
+                 &lt;span&gt;{formatCurrency(calculateTotal())}&lt;/span&gt;
                &lt;/div&gt;
-             )}
-           &lt;/div&gt;
-         &lt;/CardContent&gt;
-       &lt;/Card&gt;
+               &lt;div className="flex justify-between text-sm"&gt;
+                 &lt;span className="text-muted-foreground"&gt;IVA (Estimado)&lt;/span&gt;
+                 &lt;span&gt;{formatCurrency(calculateTotal() * 0.21)}&lt;/span&gt;
+               &lt;/div&gt;
+               &lt;div className="border-t pt-2 mt-2 flex justify-between items-center"&gt;
+                 &lt;span className="font-bold"&gt;Total Final&lt;/span&gt;
+                 &lt;span className="text-2xl font-bold text-primary"&gt;
+                   {formatCurrency(calculateTotal() * 1.21)}
+                 &lt;/span&gt;
+               &lt;/div&gt;
+               &lt;p className="text-[10px] text-muted-foreground text-right italic"&gt;
+                 * El IVA se calcula formalmente al generar la factura
+               &lt;/p&gt;
+             &lt;/CardContent&gt;
+           &lt;/Card&gt;
+         &lt;/div&gt;
+       )}
  
        {/* Warning Alert for Unprinted Documents Update */}
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
**Reviewing and Checking Consistency**

I've just finished the items table and layout updates. Currently, I'm performing a comprehensive final review of the whole file. My primary goal now is ensuring complete style consistency with the invoice detail page. The action is fixed.


**Analyzing Button Consistency**

I'm now double-checking the fixed action bar buttons across both pages. I've confirmed `SingleStepOrderForm.tsx` already uses the fixed action bar, so the primary task is style matching. While I was at it, I noticed a missed function call. I'm verifying the `updateItemDiscount` function is defined and used correctly.


**Investigating Function Definitions**

I'm now diving into the `handleUpdateDiscount` function. My initial review of `SingleStepOrderForm.tsx` revealed an existing call to `updateItemDiscount`, but I'm unsure if it's correctly defined. I need to verify its source. So I'm tracing its origin by checking `useQuickCartTabs()`.


</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** ‚Ä¢ Read file: d:\dialfa new\spisa-new\frontend\lib\hooks\useQuickCartTabs.ts</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Incorporating a Function**

I've located `updateItemDiscount` within `useQuickCartTabs.ts`. My next step is to integrate it by destructuring it within `SingleStepOrderForm.tsx`. I'll focus on the specific location for the destructuring to ensure seamless integration.


</details></think>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** ‚Ä¢ Edit file: d:\dialfa new\spisa-new\frontend\components\salesOrders\SingleStepOrderForm.tsx</summary>

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -97,4 +97,5 @@
      replaceItem,
      addOrUpdateOrderTab,
+     updateItemDiscount,
    } = useQuickCartTabs();
  
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
**Verifying Content Integrity**

I'm currently reviewing the file's contents meticulously. My focus is on ensuring all components are present and accurately placed. I'm double-checking for any omissions or inconsistencies to maintain data integrity. The goal is to certify the completeness of the data.


</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** ‚Ä¢ Read file: d:\dialfa new\spisa-new\frontend\components\salesOrders\SingleStepOrderForm.tsx</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Refactoring Order Form**

I've just finished refactoring the order form. The design now aligns with the invoice detail page. My next step is to run a linter check to ensure the code's quality and identify potential errors.


</details></think>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** ‚Ä¢ Read lints for 1 file</summary>
      
Lint paths:

- `d:\dialfa new\spisa-new\frontend\components\salesOrders\SingleStepOrderForm.tsx`

Lint results


**No lint errors found**
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Checking the Logic**

The code passed the linter, which is a good start. Currently, I'm verifying the `calculateTotal` and `calculateLineTotal` functions. Specifically, I'm focusing on the `calculateLineTotal` function, making sure it correctly retrieves the `articleId` from the `QuickCartItem`. I'll run some tests after to confirm.


**Validating Calculations**

The calculations seem accurate after reviewing the code. I've confirmed that `calculateLineTotal` correctly fetches the `articleId` and uses the relevant `unitPrice`. The total is calculated properly in the "Totals" section. Next, I plan to examine how the discount is applied, specifically the `discountPercent` implementation.


**Assessing Refactoring Success**

I've reviewed the code after the refactor and everything appears solid, including the "Totals" section. The logic for calculating subtotal, IVA, and the final total seems correct, and the component follows the expected invoice detail page pattern. I will now update the remaining TODOs.


</details></think>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** ‚Ä¢ Todo List</summary>

- [x] Refactor SingleStepOrderForm layout to match Invoice Detail style
- [x] Implement Table-based items list in Order Form
- [x] Add Totals card to Order Form
- [x] Verify consistency with Invoice Detail view

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Presenting Final Findings**

I've wrapped up all the tasks, and the final stage is upon me: summarizing the cumulative results. The synthesis is ready, and a complete overview is being compiled for your review. Expect a detailed articulation of all the alterations.


</details></think>

---

He redise√±ado el formulario de pedidos para que tenga una apariencia consistente con el detalle de las facturas, tal como solicitaste.

### Cambios realizados:

1.  **Estructura de Informaci√≥n General**:
    *   Divid√≠ la secci√≥n superior en dos tarjetas (`Card`): **Informaci√≥n del Cliente** e **Informaci√≥n del Pedido**.
    *   Ahora se muestran datos relevantes como el n√∫mero de pedido y el estado (Borrador, Pendiente, Facturado) de forma clara.
    *   Integr√© el campo de **Observaciones** dentro de la tarjeta de informaci√≥n del pedido.

2.  **Lista de Art√≠culos (Tabla)**:
    *   Reemplac√© el dise√±o anterior de filas individuales por una **Tabla (`Table`)** id√©ntica a la de las facturas.
    *   Columnas: C√≥digo, Descripci√≥n, Cantidad, Precio Unit., Descuento y Total.
    *   El buscador de art√≠culos ahora est√° integrado de forma m√°s elegante en la cabecera de la secci√≥n de items.
    *   Mantuve la capacidad de edici√≥n (cantidad, precio y descuento) directamente en las celdas de la tabla para los pedidos que no est√°n cerrados.

3.  **Resumen de Totales**:
    *   Agregu√© una tarjeta de **Resumen del Pedido** alineada a la derecha, que muestra el Subtotal, el IVA estimado y el Total Final, igual que en la vista de facturas.

4.  **Consistencia Visual**:
    *   Utilic√© los mismos componentes de UI (`Card`, `Table`, `Badge`) y estilos de espaciado que se usan en el m√≥dulo de facturaci√≥n para que la transici√≥n entre pantallas sea fluida.

Ahora, cuando veas o edites un pedido, los campos estar√°n organizados de la misma manera que en una factura, facilitando la lectura de precios, descuentos y totales.

---

