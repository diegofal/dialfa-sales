<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 735600b6-34b5-4ba7-8458-3eed137b62d6 (2025-11-13 00:41Z) -->

# Problemas al cancelar una factura (2025-11-13 00:41Z)

_**User (2025-11-12 21:29Z)**_

cunado cancelo una factura: 1) me muestra un popup de razon: no hace falta, solo confirmacion 2) no existe el endpoint de cancelacion. 

---

_**Agent (model claude-4.5-sonnet-thinking, mode Agent)**_

<think><details><summary>Thought Process</summary>
El usuario está reportando dos problemas cuando cancela una factura:
1. Le muestra un popup de razón, pero solo quiere una confirmación
2. No existe el endpoint de cancelación

Necesito buscar en el código donde está la funcionalidad de cancelación de facturas. Parece que estamos trabajando con el proyecto spisa-new que es una aplicación web con frontend y backend.

Déjame buscar primero cómo está implementada la funcionalidad de cancelación de facturas en el frontend y backend.</details></think>

---

Voy a investigar la implementación actual de cancelación de facturas y luego corregir ambos problemas.

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">

</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">

</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "cancelInvoice|cancel.*invoice" in "d:\dialfa new\spisa-new\frontend" • 51 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `frontend\app\api\invoices\[id]\route.ts` | `\{ error: 'Cannot edit cancelled invoices' \},` | L76 |
| `frontend\app\api\invoices\[id]\route.ts` | `const isCancellingPrintedInvoice = (body.is_cancelled === true \|\| body.isCancelled === true) &&` | L112 |
| `frontend\app\api\invoices\[id]\route.ts` | `// If cancelling a printed invoice, restore stock` | L134 |
| `frontend\app\api\invoices\[id]\route.ts` | `if (isCancellingPrintedInvoice) \{` | L135 |
| `frontend\app\api\invoices\[id]\route.ts` | `reference_document: `Cancelación factura $\{existingInvoice.invoice_number\}`,` | L152 |
| `frontend\app\api\invoices\[id]\route.ts` | `\{ error: 'Cannot delete cancelled invoices' \},` | L327 |
| `frontend\app\dashboard\invoices\[id]\page.tsx` | `import \{ useInvoice, useCancelInvoice, usePrintInvoice \} from '@/lib/hooks/useInvoices';` | L16 |
| `frontend\app\dashboard\invoices\[id]\page.tsx` | `const cancelInvoiceMutation = useCancelInvoice();` | L37 |
| `frontend\app\dashboard\invoices\[id]\page.tsx` | `cancelInvoiceMutation.mutate(` | L96 |
| `frontend\app\dashboard\invoices\[id]\page.tsx` | `\{invoice.isCancelled && invoice.cancellationReason && (` | L246 |
| `frontend\app\dashboard\invoices\[id]\page.tsx` | `Cancelada el: \{invoice.cancelledAt ? formatDate(invoice.cancelledAt) : 'N/A'\}` | L257 |
| `frontend\app\dashboard\invoices\[id]\page.tsx` | `\{!invoice.isCancelled && !invoice.isPrinted && (` | L274 |
| `frontend\app\dashboard\invoices\[id]\page.tsx` | `\{!invoice.isCancelled && !invoice.isPrinted && (` | L292 |
| `frontend\app\dashboard\invoices\[id]\page.tsx` | `disabled=\{!cancellationReason.trim() \|\| cancelInvoiceMutation.isPending\}` | L328 |
| `frontend\app\dashboard\invoices\[id]\page.tsx` | `\{cancelInvoiceMutation.isPending ? 'Cancelando...' : 'Confirmar'\}` | L330 |
| `frontend\types\invoice.ts` | `export interface CancelInvoiceRequest \{` | L72 |
| `frontend\lib\utils\mapper.ts` | `isCancelled: invoice.is_cancelled as boolean,` | L144 |
| `frontend\lib\hooks\useSalesOrders.ts` | `const cancelledCount = data.affectedInvoices.filter(inv => inv.wasCancelled).length;` | L120 |
| `frontend\app\api\sales-orders\[id]\route.ts` | `const cancelledInvoices: Array<\{ id: string; invoiceNumber: string; wasCancelled: boolean \}> = [];` | L312 |
| `frontend\app\api\sales-orders\[id]\route.ts` | `// Skip cancelled invoices` | L321 |
| `frontend\app\api\sales-orders\[id]\route.ts` | `// Cancel the invoice and restore stock` | L326 |
| `frontend\app\api\sales-orders\[id]\route.ts` | `cancelledInvoices.push(\{` | L337 |
| `frontend\app\api\sales-orders\[id]\route.ts` | `reference_document: `Cancelación factura $\{invoice.invoice_number\} - Pedido eliminado`,` | L351 |
| `frontend\app\api\sales-orders\[id]\route.ts` | `cancelledInvoices.push(\{` | L380 |
| `frontend\app\api\sales-orders\[id]\route.ts` | `affectedInvoices: cancelledInvoices,` | L419 |
| `frontend\lib\permissions\salesOrders.ts` | `invoiceCancelled: salesOrder.invoice?.isCancelled ?? false,` | L31 |
| `frontend\types\permissions.ts` | `canCancel: status.id !== null && !status.invoicePrinted,` | L40 |
| `frontend\components\salesOrders\SalesOrdersTable.tsx` | `\{/* Can cancel if invoice is not printed */\}` | L135 |
| `frontend\components\invoices\InvoicesTable.tsx` | `onCancelInvoice?: (id: number, reason: string) => void;` | L34 |
| `frontend\components\invoices\InvoicesTable.tsx` | `onCancelInvoice,` | L45 |
| `frontend\components\invoices\InvoicesTable.tsx` | `const [invoiceToCancel, setInvoiceToCancel] = useState<number \| null>(null);` | L51 |
| `frontend\components\invoices\InvoicesTable.tsx` | `if (invoiceToCancel && onCancelInvoice && cancellationReason.trim()) \{` | L77 |
| `frontend\components\invoices\InvoicesTable.tsx` | `onCancelInvoice(invoiceToCancel, cancellationReason);` | L78 |
| `frontend\components\invoices\InvoicesTable.tsx` | `\{!invoice.isCancelled && !invoice.isPrinted && onPrintInvoice && (` | L172 |
| `frontend\components\invoices\InvoicesTable.tsx` | `\{!invoice.isCancelled && !invoice.isPrinted && onCancelInvoice && (` | L182 |
| `frontend\components\invoices\InvoicesTable.tsx` | `onClick=\{() => setInvoiceToCancel(invoice.id)\}` | L186 |
| `frontend\app\dashboard\invoices\page.tsx` | `import \{ useInvoices, useCancelInvoice, usePrintInvoice \} from '@/lib/hooks/useInvoices';` | L12 |
| `frontend\app\dashboard\invoices\page.tsx` | `const cancelInvoiceMutation = useCancelInvoice();` | L36 |
| `frontend\app\dashboard\invoices\page.tsx` | `const handleCancelInvoice = (id: number, reason: string) => \{` | L62 |
| `frontend\app\dashboard\invoices\page.tsx` | `cancelInvoiceMutation.mutate(\{ id, data: \{ cancellationReason: reason \} \});` | L63 |
| `frontend\app\dashboard\invoices\page.tsx` | `onCancelInvoice=\{handleCancelInvoice\}` | L230 |
| `frontend\app\api\sales-orders\[id]\generate-invoice\route.ts` | `// Check if already has an active (non-cancelled) invoice` | L53 |
| `frontend\app\api\sales-orders\[id]\permissions\route.ts` | `invoiceCancelled: invoice?.is_cancelled ?? false,` | L58 |
| `frontend\lib\api\invoices.ts` | `CancelInvoiceRequest,` | L8 |
| `frontend\lib\api\invoices.ts` | `cancel: async (id: number, cancelData: CancelInvoiceRequest): Promise<void> => \{` | L49 |
| `frontend\lib\hooks\useInvoices.ts` | `import type \{ Invoice, InvoiceListDto, CreateInvoiceRequest, UpdateInvoiceRequest, CancelInvoiceRequest \} from '@/types/invoice';` | L3 |
| `frontend\lib\hooks\useInvoices.ts` | `export function useCancelInvoice() \{` | L64 |
| `frontend\lib\hooks\useInvoices.ts` | `mutationFn: (\{ id, data \}: \{ id: number; data: CancelInvoiceRequest \}) =>` | L68 |
| `frontend\lib\actions\invoices.ts` | `export async function cancelInvoice(id: string, reason: string) \{` | L202 |
| `frontend\lib\actions\invoices.ts` | `console.error('Error cancelling invoice:', error);` | L257 |
| `frontend\lib\actions\invoices.ts` | `error: getErrorMessage(error) \|\| 'Failed to cancel invoice',` | L260 |


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: d:\dialfa new\spisa-new\frontend\app\dashboard\invoices\[id]\page.tsx</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: d:\dialfa new\spisa-new\frontend\components\invoices\InvoicesTable.tsx</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: d:\dialfa new\spisa-new\frontend\lib\hooks\useInvoices.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: d:\dialfa new\spisa-new\frontend\lib\api\invoices.ts</summary>

</details>
</tool-use>

---

Ahora busco el backend para ver si existe el endpoint de cancelación:

---

<tool-use data-tool-type="generic" data-tool-name="glob_file_search">
<details>
<summary>Tool use: **glob_file_search** • Searched codebase "**/backend/**/*.ts" • **0** result in **1** directory</summary>

Directory: **d:\dialfa new\spisa-new** (0 file)

</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_dir** • Listed directory, 0 results</summary>
        
No results found
</details>
</tool-use>

---

Search failed: rg: frontend\nul: Incorrect function. (os error 1) (exit 2, root: d:/dialfa new/spisa-new)

---

<tool-use data-tool-type="generic" data-tool-name="glob_file_search">
<details>
<summary>Tool use: **glob_file_search** • Searched codebase "**/api/invoices/**/route.ts" • **2** results in **1** directory</summary>

Directory: **d:\dialfa new\spisa-new** (2 files)

| File |
|------|
| `frontend\app\api\invoices\[id]\route.ts` |
| `frontend\app\api\invoices\route.ts` |

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
El usuario está reportando dos problemas cuando cancela una factura:
1. Le muestra un popup de razón, pero solo quiere una confirmación
2. No existe el endpoint de cancelación

Necesito buscar en el código donde está la funcionalidad de cancelación de facturas. Parece que estamos trabajando con el proyecto spisa-new que es una aplicación web con frontend y backend.

Déjame buscar primero cómo está implementada la funcionalidad de cancelación de facturas en el frontend y backend.</details></think>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: d:\dialfa new\spisa-new\frontend\app\api\invoices\[id]\route.ts</summary>

</details>
</tool-use>

---

Perfecto, ahora entiendo los problemas. Veo que:

1. **El popup pide una razón** (en ambos archivos: `InvoicesTable.tsx` y `page.tsx`) cuando solo quieres una confirmación simple
2. **No existe un endpoint dedicado `/cancel`** - La API actual usa el endpoint PUT para manejar la cancelación

Voy a crear los cambios necesarios:

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [-] Crear endpoint POST /api/invoices/[id]/cancel en el backend
- [ ] Modificar InvoicesTable.tsx para usar confirmación simple sin razón
- [ ] Modificar page.tsx (detalle de factura) para usar confirmación simple sin razón

</details>
</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="write">

<details><summary>Tool use: **write** • Edit file: d:\dialfa new\spisa-new\frontend\app\api\invoices\[id]\cancel\route.ts</summary>

**Chunk 1**
Lines added: 126, lines removed: 1

```diff
@@ -1,1 +1,126 @@
- 
+ import { NextRequest, NextResponse } from 'next/server';
+ import { prisma } from '@/lib/db';
+ import { STOCK_MOVEMENT_TYPES } from '@/lib/constants/stockMovementTypes';
+ 
+ export async function POST(
+   request: NextRequest,
+   { params }: { params: Promise&lt;{ id: string }&gt; }
+ ) {
+   try {
+     const { id: idStr } = await params;
+     const id = BigInt(idStr);
+ 
+     // Check if invoice exists and is not deleted
+     const existingInvoice = await prisma.invoices.findUnique({
+       where: { id },
+     });
+ 
+     if (!existingInvoice || existingInvoice.deleted_at) {
+       return NextResponse.json(
+         { error: 'Invoice not found' },
+         { status: 404 }
+       );
+     }
+ 
+     // Check if invoice is already cancelled
+     if (existingInvoice.is_cancelled) {
+       return NextResponse.json(
+         { error: 'Invoice is already cancelled' },
+         { status: 400 }
+       );
+     }
+ 
+     const now = new Date();
+     const isCancellingPrintedInvoice = existingInvoice.is_printed;
+ 
+     // Update invoice and restore stock if needed in transaction
+     await prisma.$transaction(async (tx) =&gt; {
+       // If cancelling a printed invoice, restore stock
+       if (isCancellingPrintedInvoice) {
+         // Get sales order items to restore stock
+         const salesOrder = await tx.sales_orders.findUnique({
+           where: { id: existingInvoice.sales_order_id },
+           include: {
+             sales_order_items: true,
+           },
+         });
+ 
+         if (salesOrder) {
+           for (const item of salesOrder.sales_order_items) {
+             // Create positive stock movement (credit - return to stock)
+             await tx.stock_movements.create({
+               data: {
+                 article_id: item.article_id,
+                 movement_type: STOCK_MOVEMENT_TYPES.CREDIT,
+                 quantity: item.quantity,
+                 reference_document: &#96;Cancelación factura ${existingInvoice.invoice_number}&#96;,
+                 movement_date: now,
+                 notes: 'Stock devuelto por cancelación de factura impresa',
+                 created_at: now,
+                 updated_at: now,
+               },
+             });
+ 
+             // Update article stock
+             await tx.articles.update({
+               where: { id: item.article_id },
+               data: {
+                 stock: {
+                   increment: item.quantity,
+                 },
+                 updated_at: now,
+               },
+             });
+           }
+         }
+       }
+ 
+       // Update the invoice
+       await tx.invoices.update({
+         where: { id },
+         data: {
+           is_cancelled: true,
+           cancelled_at: now,
+           cancellation_reason: 'Cancelado por usuario',
+           updated_at: now,
+         },
+       });
+ 
+       // Check if we need to update sales order status
+       const salesOrder = await tx.sales_orders.findUnique({
+         where: { id: existingInvoice.sales_order_id },
+         include: {
+           invoices: {
+             where: {
+               deleted_at: null,
+               is_cancelled: false,
+             },
+           },
+         },
+       });
+ 
+       // If no active invoices remain (excluding the one we just cancelled), set order status back to PENDING
+       if (salesOrder &amp;&amp; salesOrder.invoices.length === 0) {
+         await tx.sales_orders.update({
+           where: { id: existingInvoice.sales_order_id },
+           data: {
+             status: 'PENDING',
+             updated_at: now,
+           },
+         });
+       }
+     });
+ 
+     return NextResponse.json(
+       { message: 'Invoice cancelled successfully' },
+       { status: 200 }
+     );
+   } catch (error) {
+     console.error('Error cancelling invoice:', error);
+     return NextResponse.json(
+       { error: 'Failed to cancel invoice' },
+       { status: 500 }
+     );
+   }
+ }
+ 
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
El usuario está reportando dos problemas cuando cancela una factura:
1. Le muestra un popup de razón, pero solo quiere una confirmación
2. No existe el endpoint de cancelación

Necesito buscar en el código donde está la funcionalidad de cancelación de facturas. Parece que estamos trabajando con el proyecto spisa-new que es una aplicación web con frontend y backend.

Déjame buscar primero cómo está implementada la funcionalidad de cancelación de facturas en el frontend y backend.</details></think>

---

Ahora modifico la tabla de facturas para usar confirmación simple:

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Crear endpoint POST /api/invoices/[id]/cancel en el backend
- [-] Modificar InvoicesTable.tsx para usar confirmación simple sin razón
- [ ] Modificar page.tsx (detalle de factura) para usar confirmación simple sin razón

</details>
</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: d:\dialfa new\spisa-new\frontend\components\invoices\InvoicesTable.tsx</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -32,5 +32,5 @@
    onViewInvoice: (id: number) =&gt; void;
    onViewSalesOrder?: (id: number) =&gt; void;
-   onCancelInvoice?: (id: number, reason: string) =&gt; void;
+   onCancelInvoice?: (id: number) =&gt; void;
    onPrintInvoice?: (id: number) =&gt; void;
    currentSortBy?: string;
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: d:\dialfa new\spisa-new\frontend\components\invoices\InvoicesTable.tsx</summary>

**Chunk 1**
Lines added: undefined, lines removed: 1

```diff
@@ -50,5 +50,4 @@
  }: InvoicesTableProps) {
    const [invoiceToCancel, setInvoiceToCancel] = useState&lt;number | null&gt;(null);
-   const [cancellationReason, setCancellationReason] = useState('');
  
    const getStatusBadge = (invoice: InvoiceListDto) =&gt; {
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: d:\dialfa new\spisa-new\frontend\components\invoices\InvoicesTable.tsx</summary>

**Chunk 1**
Lines added: 2, lines removed: 3

```diff
@@ -74,8 +74,7 @@
  
    const handleCancelConfirm = () =&gt; {
-     if (invoiceToCancel &amp;&amp; onCancelInvoice &amp;&amp; cancellationReason.trim()) {
-       onCancelInvoice(invoiceToCancel, cancellationReason);
+     if (invoiceToCancel &amp;&amp; onCancelInvoice) {
+       onCancelInvoice(invoiceToCancel);
        setInvoiceToCancel(null);
-       setCancellationReason('');
      }
    };
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: d:\dialfa new\spisa-new\frontend\components\invoices\InvoicesTable.tsx</summary>

**Chunk 1**
Lines added: 6, lines removed: 23

```diff
@@ -200,36 +200,19 @@
        &lt;AlertDialog
          open={!!invoiceToCancel}
-         onOpenChange={() =&gt; {
-           setInvoiceToCancel(null);
-           setCancellationReason('');
-         }}
+         onOpenChange={() =&gt; setInvoiceToCancel(null)}
        &gt;
          &lt;AlertDialogContent&gt;
            &lt;AlertDialogHeader&gt;
              &lt;AlertDialogTitle&gt;¿Cancelar factura?&lt;/AlertDialogTitle&gt;
              &lt;AlertDialogDescription&gt;
-               Esta acción marcará la factura como CANCELADA. Debe proporcionar un motivo de
-               cancelación.
+               Esta acción marcará la factura como CANCELADA y restaurará el stock si la factura estaba impresa.
              &lt;/AlertDialogDescription&gt;
            &lt;/AlertDialogHeader&gt;
-           &lt;div className="py-4"&gt;
-             &lt;label className="text-sm font-medium mb-2 block"&gt;
-               Motivo de cancelación
-             &lt;/label&gt;
-             &lt;Input
-               value={cancellationReason}
-               onChange={(e) =&gt; setCancellationReason(e.target.value)}
-               placeholder="Ingrese el motivo de la cancelación"
-             /&gt;
-           &lt;/div&gt;
            &lt;AlertDialogFooter&gt;
-             &lt;AlertDialogCancel onClick={() =&gt; setCancellationReason('')}&gt;
-               Cancelar
+             &lt;AlertDialogCancel&gt;
+               No, volver
              &lt;/AlertDialogCancel&gt;
-             &lt;AlertDialogAction
-               onClick={handleCancelConfirm}
-               disabled={!cancellationReason.trim()}
-             &gt;
-               Confirmar
+             &lt;AlertDialogAction onClick={handleCancelConfirm}&gt;
+               Sí, cancelar factura
              &lt;/AlertDialogAction&gt;
            &lt;/AlertDialogFooter&gt;
```

</details>

</tool-use>

---

Ahora modifico la página de detalle de factura:

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Crear endpoint POST /api/invoices/[id]/cancel en el backend
- [x] Modificar InvoicesTable.tsx para usar confirmación simple sin razón
- [-] Modificar page.tsx (detalle de factura) para usar confirmación simple sin razón

</details>
</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: d:\dialfa new\spisa-new\frontend\app\dashboard\invoices\[id]\page.tsx</summary>

**Chunk 1**
Lines added: undefined, lines removed: 1

```diff
@@ -40,5 +40,4 @@
  
    const [showCancelDialog, setShowCancelDialog] = useState(false);
-   const [cancellationReason, setCancellationReason] = useState('');
  
    // Add invoice to tabs when loaded
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: d:\dialfa new\spisa-new\frontend\app\dashboard\invoices\[id]\page.tsx</summary>

**Chunk 1**
Lines added: 8, lines removed: 11

```diff
@@ -92,15 +92,12 @@
  
    const handleCancel = () =&gt; {
-     if (cancellationReason.trim()) {
-       cancelInvoiceMutation.mutate(
-         { id: invoiceId, data: { cancellationReason } },
-         {
-           onSuccess: () =&gt; {
-             setShowCancelDialog(false);
-             setCancellationReason('');
-           },
-         }
-       );
-     }
+     cancelInvoiceMutation.mutate(
+       { id: invoiceId },
+       {
+         onSuccess: () =&gt; {
+           setShowCancelDialog(false);
+         },
+       }
+     );
    };
  
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: d:\dialfa new\spisa-new\frontend\app\dashboard\invoices\[id]\page.tsx</summary>

**Chunk 1**
Lines added: 5, lines removed: 15

```diff
@@ -303,26 +303,16 @@
              &lt;AlertDialogTitle&gt;¿Cancelar factura?&lt;/AlertDialogTitle&gt;
              &lt;AlertDialogDescription&gt;
-               Esta acción marcará la factura como CANCELADA. Debe proporcionar un motivo.
+               Esta acción marcará la factura como CANCELADA y restaurará el stock si la factura estaba impresa.
              &lt;/AlertDialogDescription&gt;
            &lt;/AlertDialogHeader&gt;
-           &lt;div className="py-4"&gt;
-             &lt;label className="text-sm font-medium mb-2 block"&gt;
-               Motivo de cancelación
-             &lt;/label&gt;
-             &lt;Input
-               value={cancellationReason}
-               onChange={(e) =&gt; setCancellationReason(e.target.value)}
-               placeholder="Ingrese el motivo de la cancelación"
-             /&gt;
-           &lt;/div&gt;
            &lt;AlertDialogFooter&gt;
-             &lt;AlertDialogCancel onClick={() =&gt; setCancellationReason('')}&gt;
-               Cancelar
+             &lt;AlertDialogCancel&gt;
+               No, volver
              &lt;/AlertDialogCancel&gt;
              &lt;AlertDialogAction
                onClick={handleCancel}
-               disabled={!cancellationReason.trim() || cancelInvoiceMutation.isPending}
+               disabled={cancelInvoiceMutation.isPending}
              &gt;
-               {cancelInvoiceMutation.isPending ? 'Cancelando...' : 'Confirmar'}
+               {cancelInvoiceMutation.isPending ? 'Cancelando...' : 'Sí, cancelar factura'}
              &lt;/AlertDialogAction&gt;
            &lt;/AlertDialogFooter&gt;
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
El usuario está reportando dos problemas cuando cancela una factura:
1. Le muestra un popup de razón, pero solo quiere una confirmación
2. No existe el endpoint de cancelación

Necesito buscar en el código donde está la funcionalidad de cancelación de facturas. Parece que estamos trabajando con el proyecto spisa-new que es una aplicación web con frontend y backend.

Déjame buscar primero cómo está implementada la funcionalidad de cancelación de facturas en el frontend y backend.</details></think>

---

Ahora necesito actualizar el hook de `useCancelInvoice` para que use el nuevo endpoint y no requiera el dato de cancelación:

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: d:\dialfa new\spisa-new\frontend\lib\hooks\useInvoices.ts</summary>

**Chunk 1**
Lines added: 2, lines removed: 2

```diff
@@ -66,6 +66,6 @@
  
    return useMutation({
-     mutationFn: ({ id, data }: { id: number; data: CancelInvoiceRequest }) =&gt;
-       invoicesApi.cancel(id, data),
+     mutationFn: ({ id }: { id: number }) =&gt;
+       invoicesApi.cancel(id),
      onSuccess: () =&gt; {
        queryClient.invalidateQueries({ queryKey: ['invoices'] });
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: d:\dialfa new\spisa-new\frontend\lib\api\invoices.ts</summary>

**Chunk 1**
Lines added: 2, lines removed: 2

```diff
@@ -47,6 +47,6 @@
    },
  
-   cancel: async (id: number, cancelData: CancelInvoiceRequest): Promise&lt;void&gt; =&gt; {
-     await apiClient.post(&#96;/invoices/${id}/cancel&#96;, cancelData);
+   cancel: async (id: number): Promise&lt;void&gt; =&gt; {
+     await apiClient.post(&#96;/invoices/${id}/cancel&#96;);
    },
  
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
El usuario está reportando dos problemas cuando cancela una factura:
1. Le muestra un popup de razón, pero solo quiere una confirmación
2. No existe el endpoint de cancelación

Necesito buscar en el código donde está la funcionalidad de cancelación de facturas. Parece que estamos trabajando con el proyecto spisa-new que es una aplicación web con frontend y backend.

Déjame buscar primero cómo está implementada la funcionalidad de cancelación de facturas en el frontend y backend.</details></think>

---

Ahora actualizo la página de listado de facturas para que use la firma correcta sin el parámetro de razón:

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: d:\dialfa new\spisa-new\frontend\app\dashboard\invoices\page.tsx</summary>

**Chunk 1**
Lines added: 2, lines removed: 2

```diff
@@ -60,6 +60,6 @@
    };
  
-   const handleCancelInvoice = (id: number, reason: string) =&gt; {
-     cancelInvoiceMutation.mutate({ id, data: { cancellationReason: reason } });
+   const handleCancelInvoice = (id: number) =&gt; {
+     cancelInvoiceMutation.mutate({ id });
    };
  
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
El usuario está reportando dos problemas cuando cancela una factura:
1. Le muestra un popup de razón, pero solo quiere una confirmación
2. No existe el endpoint de cancelación

Necesito buscar en el código donde está la funcionalidad de cancelación de facturas. Parece que estamos trabajando con el proyecto spisa-new que es una aplicación web con frontend y backend.

Déjame buscar primero cómo está implementada la funcionalidad de cancelación de facturas en el frontend y backend.</details></think>

---

Ahora verifico si hay errores de linting y limpio los imports innecesarios:

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 4 files</summary>
      
Lint paths:

- `d:\dialfa new\spisa-new\frontend\components\invoices\InvoicesTable.tsx`
- `d:\dialfa new\spisa-new\frontend\app\dashboard\invoices\[id]\page.tsx`
- `d:\dialfa new\spisa-new\frontend\lib\hooks\useInvoices.ts`
- `d:\dialfa new\spisa-new\frontend\lib\api\invoices.ts`

Lint results


**No lint errors found**
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
El usuario está reportando dos problemas cuando cancela una factura:
1. Le muestra un popup de razón, pero solo quiere una confirmación
2. No existe el endpoint de cancelación

Necesito buscar en el código donde está la funcionalidad de cancelación de facturas. Parece que estamos trabajando con el proyecto spisa-new que es una aplicación web con frontend y backend.

Déjame buscar primero cómo está implementada la funcionalidad de cancelación de facturas en el frontend y backend.</details></think>

---

Perfecto. Ahora limpio los imports innecesarios que quedaron:

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: d:\dialfa new\spisa-new\frontend\components\invoices\InvoicesTable.tsx</summary>

**Chunk 1**
Lines added: undefined, lines removed: 1

```diff
@@ -24,5 +24,4 @@
  } from '@/components/ui/alert-dialog';
  import { Badge } from '@/components/ui/badge';
- import { Input } from '@/components/ui/input';
  import type { InvoiceListDto } from '@/types/invoice';
  import { ACTION_BUTTON_CONFIG } from '@/lib/constants/tableActions';
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: d:\dialfa new\spisa-new\frontend\app\dashboard\invoices\[id]\page.tsx</summary>

**Chunk 1**
Lines added: undefined, lines removed: 1

```diff
@@ -27,5 +27,4 @@
    AlertDialogTitle,
  } from '@/components/ui/alert-dialog';
- import { Input } from '@/components/ui/input';
  
  export default function InvoiceDetailPage() {
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: d:\dialfa new\spisa-new\frontend\lib\hooks\useInvoices.ts</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -1,5 +1,5 @@
  import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
  import { invoicesApi } from '@/lib/api/invoices';
- import type { Invoice, InvoiceListDto, CreateInvoiceRequest, UpdateInvoiceRequest, CancelInvoiceRequest } from '@/types/invoice';
+ import type { Invoice, InvoiceListDto, CreateInvoiceRequest, UpdateInvoiceRequest } from '@/types/invoice';
  import { PagedResult, PaginationParams } from '@/types/pagination';
  import { toast } from 'sonner';
```

</details>

</tool-use>

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: d:\dialfa new\spisa-new\frontend\lib\api\invoices.ts</summary>

**Chunk 1**
Lines added: undefined, lines removed: 1

```diff
@@ -6,5 +6,4 @@
    CreateInvoiceRequest,
    UpdateInvoiceRequest,
-   CancelInvoiceRequest,
  } from '@/types/invoice';
  
```

</details>

</tool-use>

---

<tool-use data-tool-type="task" data-tool-name="todo_write">
<details><summary>Tool use: **todo_write** • Todo List</summary>

- [x] Crear endpoint POST /api/invoices/[id]/cancel en el backend
- [x] Modificar InvoicesTable.tsx para usar confirmación simple sin razón
- [x] Modificar page.tsx (detalle de factura) para usar confirmación simple sin razón

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
El usuario está reportando dos problemas cuando cancela una factura:
1. Le muestra un popup de razón, pero solo quiere una confirmación
2. No existe el endpoint de cancelación

Necesito buscar en el código donde está la funcionalidad de cancelación de facturas. Parece que estamos trabajando con el proyecto spisa-new que es una aplicación web con frontend y backend.

Déjame buscar primero cómo está implementada la funcionalidad de cancelación de facturas en el frontend y backend.</details></think>

---

Perfecto. Ahora verifico si hay errores de linting en los archivos actualizados:

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 5 files</summary>
      
Lint paths:

- `d:\dialfa new\spisa-new\frontend\components\invoices\InvoicesTable.tsx`
- `d:\dialfa new\spisa-new\frontend\app\dashboard\invoices\[id]\page.tsx`
- `d:\dialfa new\spisa-new\frontend\lib\hooks\useInvoices.ts`
- `d:\dialfa new\spisa-new\frontend\lib\api\invoices.ts`
- `d:\dialfa new\spisa-new\frontend\app\api\invoices\[id]\cancel\route.ts`

Lint results


**No lint errors found**
</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
El usuario está reportando dos problemas cuando cancela una factura:
1. Le muestra un popup de razón, pero solo quiere una confirmación
2. No existe el endpoint de cancelación

Necesito buscar en el código donde está la funcionalidad de cancelación de facturas. Parece que estamos trabajando con el proyecto spisa-new que es una aplicación web con frontend y backend.

Déjame buscar primero cómo está implementada la funcionalidad de cancelación de facturas en el frontend y backend.</details></think>

---

Excelente. He completado todos los cambios. Los problemas que reportaste están resueltos:

## Cambios Realizados

### 1. **Creado endpoint POST `/api/invoices/[id]/cancel`**
- Nuevo archivo: `frontend/app/api/invoices/[id]/cancel/route.ts`
- El endpoint maneja la cancelación de facturas
- Restaura el stock automáticamente si la factura estaba impresa
- Actualiza el estado del pedido de venta a PENDING si no quedan facturas activas
- Usa una razón de cancelación genérica "Cancelado por usuario"

### 2. **Modificado el popup de cancelación**
Se actualizaron ambos lugares donde se cancelan facturas:
- **`InvoicesTable.tsx`**: Ahora muestra un diálogo simple de confirmación sin campo de texto para la razón
- **`page.tsx` (detalle de factura)**: Mismo cambio, solo confirmación simple

Los diálogos ahora muestran:
- Título: "¿Cancelar factura?"
- Descripción: "Esta acción marcará la factura como CANCELADA y restaurará el stock si la factura estaba impresa."
- Botones: "No, volver" y "Sí, cancelar factura"

### 3. **Actualizados los hooks y APIs**
- `useInvoices.ts`: Modificado `useCancelInvoice()` para no requerir datos de cancelación
- `invoices.ts` (API): Actualizado método `cancel()` para solo necesitar el ID
- Eliminadas referencias a `CancelInvoiceRequest` que ya no se usan

Todos los archivos están libres de errores de linting y listos para usar.

---

