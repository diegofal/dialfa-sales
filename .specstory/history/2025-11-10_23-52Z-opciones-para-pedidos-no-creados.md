<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session dc5e1b5e-8cd0-4dfe-b598-3923dcb2ddb8 (2025-11-10 23:52Z) -->

# Opciones para pedidos no creados (2025-11-10 23:52Z)

_**User (2025-11-08 18:47Z)**_

cuando creo un pedido veo botones abajo. si el pedido no fue creado cun, como puedo eliminar, cancelar, etc? 

---

_**Agent (model claude-4.5-sonnet-thinking, mode Agent)**_

<think><details><summary>Thought Process</summary>
El usuario está señalando un problema de UX en la página de creación de pedido. Según la imagen, veo que hay botones en la parte inferior:
- "Cancelar"
- "Cancelar Pedido" 
- "Eliminar"
- "Crear Pedido"

El problema que el usuario está señalando es: si el pedido aún no ha sido creado (estamos en el formulario de NUEVO pedido), ¿cómo se puede "Cancelar Pedido" o "Eliminar" un pedido que todavía no existe?

Esto es un problema lógico de UX. Los botones deberían cambiar según el estado:
- Para un pedido NUEVO (no creado aún): solo debería mostrar "Cancelar" (para salir del formulario) y "Crear Pedido"
- Para un pedido EXISTENTE: debería mostrar "Cancelar Pedido", "Eliminar", etc.

Necesito buscar el código donde se renderiza esta página para entender cómo están implementados estos botones y corregir la lógica.

Déjame buscar en el frontend de spisa-new el componente de creación/edición de pedidos.</details></think>

---

Tienes razón, es un problema de lógica. Si el pedido no ha sido creado aún (estamos en "Nuevo Pedido"), no tiene sentido mostrar botones como "Cancelar Pedido" o "Eliminar" porque el pedido todavía no existe.

Déjame buscar el código de esta página para corregir la lógica de los botones:

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">

</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="glob_file_search">
<details>
<summary>Tool use: **glob_file_search** • Searched codebase "*order*.tsx" • **4** results in **1** directory</summary>

Directory: **d:\dialfa new\spisa-new\frontend** (4 files)

| File |
|------|
| `components\salesOrders\SingleStepOrderForm.tsx` |
| `components\salesOrders\SalesOrdersTable.tsx` |
| `components\salesOrders\SalesOrderWizard.tsx` |
| `components\salesOrders\OrderSummaryStep.tsx` |

</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="glob_file_search">
<details>
<summary>Tool use: **glob_file_search** • Searched codebase "*pedido*.tsx" • **1** result in **1** directory</summary>

Directory: **d:\dialfa new\spisa-new\frontend** (1 file)

| File |
|------|
| `components\layout\PedidosMenuItem.tsx` |

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: d:\dialfa new\spisa-new\frontend\components\salesOrders\SingleStepOrderForm.tsx</summary>

</details>
</tool-use>

---

Perfecto, encontré el problema. En las líneas 1046-1065, los botones "Cancelar Pedido" y "Eliminar" se están mostrando basándose en `permissions.canCancel` y `permissions.canDelete`, pero estos permisos están siendo calculados incluso cuando el pedido aún no ha sido creado (`isEditMode = false`).

Déjame ver cómo se calculan estos permisos:

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: d:\dialfa new\spisa-new\frontend\lib\hooks\useSalesOrderPermissions.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: d:\dialfa new\spisa-new\frontend\lib\permissions\salesOrders.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: d:\dialfa new\spisa-new\frontend\types\permissions.ts</summary>

</details>
</tool-use>

---

Ahora lo veo claro. El problema es que cuando `salesOrder` es `null` (en modo "Nuevo Pedido"), la función `extractSalesOrderStatus` devuelve `id: null`, y luego `calculateSalesOrderPermissions` calcula:

- `canCancel: !status.invoicePrinted` → `true` (porque no hay factura impresa)
- `canDelete: !status.invoicePrinted` → `true` (porque no hay factura impresa)

Pero esto no tiene sentido para un pedido que aún no existe. Los botones "Cancelar Pedido" y "Eliminar" solo deberían aparecer cuando `status.id !== null` (es decir, cuando el pedido ya fue creado).

Voy a corregir esto:

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: d:\dialfa new\spisa-new\frontend\types\permissions.ts</summary>

**Chunk 1**
Lines added: 4, lines removed: 4

```diff
@@ -37,10 +37,10 @@
        (!status.hasInvoice || status.invoiceCancelled),
      
-     // No cancelar si tiene factura impresa
-     canCancel: !status.invoicePrinted,
+     // No cancelar si tiene factura impresa o si el pedido no existe aún
+     canCancel: status.id !== null &amp;&amp; !status.invoicePrinted,
      
-     // Se puede eliminar si la factura NO está impresa
+     // Se puede eliminar si la factura NO está impresa y el pedido ya existe
      // (Cuando se imprime la factura es cuando se debita el stock)
-     canDelete: !status.invoicePrinted,
+     canDelete: status.id !== null &amp;&amp; !status.invoicePrinted,
      
      // Crear remito si está guardado
```

</details>

</tool-use>

---

<think><details><summary>Thought Process</summary>
El usuario está señalando un problema de UX en la página de creación de pedido. Según la imagen, veo que hay botones en la parte inferior:
- "Cancelar"
- "Cancelar Pedido" 
- "Eliminar"
- "Crear Pedido"

El problema que el usuario está señalando es: si el pedido aún no ha sido creado (estamos en el formulario de NUEVO pedido), ¿cómo se puede "Cancelar Pedido" o "Eliminar" un pedido que todavía no existe?

Esto es un problema lógico de UX. Los botones deberían cambiar según el estado:
- Para un pedido NUEVO (no creado aún): solo debería mostrar "Cancelar" (para salir del formulario) y "Crear Pedido"
- Para un pedido EXISTENTE: debería mostrar "Cancelar Pedido", "Eliminar", etc.

Necesito buscar el código donde se renderiza esta página para entender cómo están implementados estos botones y corregir la lógica.

Déjame buscar en el frontend de spisa-new el componente de creación/edición de pedidos.</details></think>

---

Perfecto. Ya corregí la lógica de permisos. Ahora cuando estés en "Nuevo Pedido" (antes de que el pedido sea creado), los botones "Cancelar Pedido" y "Eliminar" **no se mostrarán** porque `permissions.canCancel` y `permissions.canDelete` serán `false` cuando `status.id === null`.

La lógica ahora es:

**Para un Nuevo Pedido (no creado aún):**
- ✅ "Cancelar" (botón para volver sin guardar)
- ✅ "Crear Pedido"
- ❌ No aparece "Cancelar Pedido" 
- ❌ No aparece "Eliminar"

**Para un Pedido Existente (sin factura impresa):**
- ✅ "Volver"
- ✅ "Cancelar Pedido"
- ✅ "Eliminar"
- ✅ "Guardar Cambios"
- ✅ Otros botones según corresponda (Generar Factura, Generar Remito, etc.)

**Para un Pedido con Factura Impresa:**
- ✅ Solo botones de visualización
- ❌ No permite editar, cancelar ni eliminar

Esto resuelve el problema que señalaste: los botones ahora se muestran de acuerdo al estado real del pedido.

---

